# Requirements Archive: v2.0 Async Architecture + Sequence Packing

**Archived:** 2026-02-09
**Status:** SHIPPED

This is the archived requirements specification for v2.0.

---

## v2.0 Requirements

Requirements for v2.0 async architecture and sequence packing milestone.

### Architecture (Async DataLoader)

- [x] **ARCH-01**: Single GPU process per GPU (replace multi-worker-per-GPU pattern)
- [x] **ARCH-02**: Async DataLoader with CPU workers (num_workers=4-8 for I/O parallelism)
- [x] **ARCH-03**: Batch prefetching (prefetch_factor=2 to overlap data loading with compute)
- [x] **ARCH-04**: GPU memory pinning in main process only (pin_memory=True in DataLoader)
- [x] **ARCH-05**: CUDA stream processing for async I/O overlap
- [x] **ARCH-06**: Triple-buffered async pipeline (H2D/compute/D2H stream overlap)
- [x] **ARCH-07**: Buffer size matching GPU batch output
- [x] **ARCH-08**: Overflow handling - backpressure if I/O thread falls behind
- [x] **ARCH-09**: FlashAttention variable-length support (flash_attn_varlen_func)
- [x] **ARCH-10**: SequenceDataset (IterableDataset) streams FASTA sequences with file-level sharding
- [x] **ARCH-11**: Length-aware sharding - sort sequences by length for packing density

### CUDA Safety

- [x] **SAFE-01**: CPU workers must NOT initialize CUDA
- [x] **SAFE-02**: Use spawn method for multiprocessing
- [x] **SAFE-03**: Deferred CUDA initialization in GPU processes
- [x] **SAFE-04**: Worker process validation (assert workers only do CPU work)
- [x] **SAFE-05**: Memory pinning safety (only main process pins memory)

### Sequence Packing

- [x] **PACK-01**: FlashAttention varlen integration with cu_seqlens
- [x] **PACK-02**: PackingCollator (VarlenCollator) packs sequences into dense batches
- [x] **PACK-03**: Dynamic token budget calculation based on GPU memory
- [x] **PACK-04**: Unpacking validation - cosine similarity >0.999
- [x] **PACK-04b**: Validation mode - FP32 ground-truth comparison
- [x] **PACK-05**: Cross-contamination test (position IDs, attention masks, dtype)
- [x] **PACK-06**: Outlier strategy for sequences exceeding token budget
- [x] **PACK-06a**: Sequences >max_length processed in isolated batch_size=1

### Precision

- [x] **PREC-01**: FP16 mixed precision via model.half()
- [x] **PREC-02**: Accuracy validation - cosine similarity >0.99 between FP16 and FP32
- [x] **PREC-03**: Selective FP32 for numerically unstable layers — SKIPPED (not needed, FP16 stable)

### Multi-GPU Coordination

- [x] **GPU-01**: GPUProcessCoordinator spawns independent processes (1 per GPU)
- [x] **GPU-02**: Stride-based index sharding across GPUs (replaced file-level)
- [x] **GPU-03**: Checkpoint aggregation from multiple GPU outputs
- [x] **GPU-04**: Per-GPU checkpoint markers (shard files + .done markers)

### Checkpointing & Resume

- [x] **CKPT-01**: Incremental checkpointing every 10K sequences per shard
- [x] **CKPT-02**: Resume from last checkpoint without reprocessing
- [x] **CKPT-03**: Atomic shard completion markers
- [x] **CKPT-04**: Atomic writes for checkpoint files (temp + rename)
- [x] **CKPT-05**: Checkpoint validation (size check, sequence count, load test)
- [x] **CKPT-06**: Per-GPU checkpoint isolation

### Performance & Validation

- [x] **PERF-01**: Pipeline completes 1M subset in <1 hour on 1x RTX 4090 — Achieved: 53:20
- [x] **PERF-02**: GPU utilization >80% during embedding steps — Partial: 60-80% (measurement methodology questionable)
- [x] **PERF-03**: Linear GPU scaling verified — ESM-2: 1.87x/93.7% (excellent); overall: 1.58x (DNABERT-S drag)
- [x] **PERF-04**: Throughput targets — ESM-2: 321 seq/s, 16.5K tokens/s on single 4090
- [x] **PERF-05**: Telemetry - tokens/sec, packing efficiency, per-stage timing logged

---

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| ARCH-01 | Phase 5 | Complete |
| ARCH-02 | Phase 5 | Complete |
| ARCH-03 | Phase 5 | Complete |
| ARCH-04 | Phase 5 | Complete |
| ARCH-05 | Phase 5 | Complete |
| ARCH-06 | Phase 7 | Complete |
| ARCH-07 | Phase 7 | Complete |
| ARCH-08 | Phase 7 | Complete |
| ARCH-09 | Phase 6 | Complete |
| ARCH-10 | Phase 6 | Complete |
| ARCH-11 | Phase 6 | Complete |
| SAFE-01 | Phase 5 | Complete |
| SAFE-02 | Phase 5 | Complete |
| SAFE-03 | Phase 5 | Complete |
| SAFE-04 | Phase 5 | Complete |
| SAFE-05 | Phase 5 | Complete |
| PACK-01 | Phase 6 | Complete |
| PACK-02 | Phase 6 | Complete |
| PACK-03 | Phase 6 | Complete |
| PACK-04 | Phase 6 | Complete |
| PACK-04b | Phase 6 | Complete |
| PACK-05 | Phase 6 | Complete |
| PACK-06 | Phase 6 | Complete |
| PACK-06a | Phase 6 | Complete |
| PREC-01 | Phase 8 | Complete |
| PREC-02 | Phase 8 | Complete |
| PREC-03 | Phase 8 | Skipped (not needed) |
| GPU-01 | Phase 7 | Complete |
| GPU-02 | Phase 7 | Complete |
| GPU-03 | Phase 7 | Complete |
| GPU-04 | Phase 7 | Complete |
| CKPT-01 | Phase 9 | Complete |
| CKPT-02 | Phase 9 | Complete |
| CKPT-03 | Phase 9 | Complete |
| CKPT-04 | Phase 9 | Complete |
| CKPT-05 | Phase 9 | Complete |
| CKPT-06 | Phase 9 | Complete |
| PERF-01 | Phase 10 | Complete |
| PERF-02 | Phase 10 | Partial (60-80%) |
| PERF-03 | Phase 10 | Partial (ESM-2 excellent, overall limited by DNABERT-S) |
| PERF-04 | Phase 10 | Complete |
| PERF-05 | Phase 10 | Complete |

**Coverage:**
- v2.0 requirements: 42 total
- Complete: 39/42
- Partial: 2/42 (PERF-02, PERF-03 — limited by DNABERT-S v1.0 architecture)
- Skipped: 1/42 (PREC-03 — conditional, not needed)

## Milestone Summary

**Shipped:** 41 of 42 v2.0 requirements (1 skipped, 2 partial)
**Adjusted:** PERF-02 and PERF-03 partially met — GPU utilization and overall scaling limited by DNABERT-S v1.0 architecture staying on bin-packing. ESM-2 v2.0 components meet targets individually.
**Dropped:** None
**Skipped:** PREC-03 (selective FP32 fallback for LayerNorm) — FP16 proved stable, not needed

---
*Archived: 2026-02-09 as part of v2.0 milestone completion*
