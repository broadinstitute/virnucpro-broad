---
phase: 07-multi-gpu-coordination
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - virnucpro/pipeline/worker_logging.py
  - tests/unit/test_worker_logging.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Each worker writes to separate log file (worker_{rank}.log)"
    - "Log format includes worker rank for easy identification"
    - "Append mode preserves logs from previous runs"
    - "Console handler shows warnings/errors only"
  artifacts:
    - path: "virnucpro/pipeline/worker_logging.py"
      provides: "setup_worker_logging function for per-worker log files"
      exports: ["setup_worker_logging"]
    - path: "tests/unit/test_worker_logging.py"
      provides: "Unit tests for worker logging setup"
      min_lines: 40
  key_links:
    - from: "setup_worker_logging"
      to: "logging.FileHandler"
      via: "Per-worker file handler with append mode"
      pattern: "FileHandler.*mode.*a"
---

<objective>
Create per-worker logging infrastructure for multi-GPU workers.

Purpose: Each GPU worker writes to its own log file (worker_0.log, worker_1.log, etc.) to avoid log interleaving. This enables debugging of individual worker failures without parsing a shared log.

Output: setup_worker_logging function that configures per-worker file handlers.
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-multi-gpu-coordination/07-CONTEXT.md
@.planning/phases/07-multi-gpu-coordination/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create worker logging module</name>
  <files>virnucpro/pipeline/worker_logging.py</files>
  <action>
Create new module virnucpro/pipeline/worker_logging.py:

1. setup_worker_logging(rank: int, log_dir: Path, log_level: int = logging.INFO) -> Path:
   """
   Configure per-worker logging to separate files.

   Each worker gets: {log_dir}/worker_{rank}.log

   Args:
       rank: Worker rank (0, 1, 2, ...)
       log_dir: Directory for log files
       log_level: Logging level (default: INFO)

   Returns:
       Path to the worker's log file
   """
   - log_dir.mkdir(parents=True, exist_ok=True)
   - log_file = log_dir / f"worker_{rank}.log"

   - Get root logger
   - Remove any existing handlers (prevent duplicate logging)

   - Create file handler with APPEND mode (mode='a'):
     - Set level to log_level
     - Format: '%(asctime)s - Worker {rank} - %(name)s - %(levelname)s - %(message)s'

   - Create console handler for immediate feedback:
     - Set level to WARNING (only warnings/errors to console)
     - Same format as file handler

   - Add both handlers to root logger
   - Set root logger level to log_level

   - Log: "Worker {rank} logging initialized: {log_file}"
   - Return log_file path

2. Add timestamp separator for resume detection:
   - When file exists (resume scenario), log separator line:
     "=== Resume at {timestamp} ==="
   - This helps distinguish between runs in same log file

3. Helper: get_worker_log_path(log_dir: Path, rank: int) -> Path:
   - Simple utility to get log path without setting up logging
   - Used by parent process to find worker logs after completion
  </action>
  <verify>
```
python -c "from virnucpro.pipeline.worker_logging import setup_worker_logging; print('OK')"
```
  </verify>
  <done>
- setup_worker_logging creates per-worker log files
- Append mode preserves previous run logs
- Console handler shows only warnings/errors
- Resume separator logged for debugging
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for worker logging</name>
  <files>tests/unit/test_worker_logging.py</files>
  <action>
Create tests/unit/test_worker_logging.py:

1. Test fixtures:
   - temp_log_dir: Temp directory for log files

2. TestWorkerLogging class:
   - test_creates_log_file: setup_worker_logging creates worker_0.log
   - test_log_file_format: Log messages include worker rank
   - test_append_mode: Multiple calls append to same file (file grows)
   - test_resume_separator: Resume logs separator line
   - test_console_handler_level: Console only receives WARNING and above
   - test_multiple_workers: Rank 0, 1, 2 create separate files

3. TestGetWorkerLogPath class:
   - test_get_path_without_setup: Returns correct path without side effects
   - test_path_matches_setup: Path matches what setup_worker_logging creates

Use pytest, tempfile, caplog (pytest's log capture).
  </action>
  <verify>
```
pytest tests/unit/test_worker_logging.py -v
```
All tests pass.
  </verify>
  <done>
- Worker logging tests verify file creation, format, append mode
- Resume separator and console handler tested
- All tests pass
  </done>
</task>

</tasks>

<verification>
1. Run unit tests: `pytest tests/unit/test_worker_logging.py -v`
2. Manual test: Call setup_worker_logging, verify log file created with correct format
3. Verify append mode: Call twice, check file contains both sessions with separator
</verification>

<success_criteria>
- Per-worker log files created with correct naming
- Append mode preserves logs from previous runs
- Console handler filters to warnings/errors only
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-multi-gpu-coordination/07-03-SUMMARY.md`
</output>
