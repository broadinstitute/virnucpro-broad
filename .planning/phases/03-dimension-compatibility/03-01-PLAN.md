---
phase: 03-dimension-compatibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - units.py
autonomous: true

must_haves:
  truths:
    - "merge_data() produces 2048-dim concatenated features (768 DNA + 1280 protein)"
    - "Dimension mismatches at merge points raise DimensionError with expected vs actual dims"
    - "VALIDATE_DIMS environment variable controls optional validation checks"
    - "Critical path validations (merge inputs/outputs) always run regardless of VALIDATE_DIMS"
  artifacts:
    - path: "units.py"
      provides: "DimensionError class, dimension constants, validation functions, updated merge_data()"
      contains: "class DimensionError"
    - path: "units.py"
      provides: "Dimension constants"
      contains: "NEW_PROTEIN_DIM = 1280"
    - path: "units.py"
      provides: "Configurable validation toggle"
      contains: "VALIDATE_DIMS"
  key_links:
    - from: "units.py:merge_data()"
      to: "units.py:validate_merge_inputs()"
      via: "function call before torch.cat()"
      pattern: "validate_merge_inputs"
    - from: "units.py:merge_data()"
      to: "units.py:validate_merged_output()"
      via: "function call after torch.cat()"
      pattern: "validate_merged_output"
    - from: "units.py:validate_merge_inputs()"
      to: "units.py:DimensionError"
      via: "raises on mismatch"
      pattern: "raise DimensionError"
---

<objective>
Add dimension constants, DimensionError exception class, validation functions, and update merge_data() with comprehensive dimension validation for the FastESM2_650 migration (768 DNA + 1280 protein = 2048 merged features).

Purpose: Establishes the foundation for all dimension compatibility work. Without centralized constants and validation, dimension mismatches would silently propagate through the pipeline causing cryptic failures during training.

Output: Updated units.py with DimensionError class, dimension constants (NEW_DNA_DIM=768, NEW_PROTEIN_DIM=1280, NEW_MERGED_DIM=2048), validation functions, VALIDATE_DIMS toggle, and merge_data() with dimension validation at inputs and outputs.
</objective>

<execution_context>
@/home/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dimension-compatibility/03-CONTEXT.md
@.planning/phases/03-dimension-compatibility/03-RESEARCH.md
@units.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DimensionError, constants, and validation functions to units.py</name>
  <files>units.py</files>
  <action>
Add the following to units.py, placed after the existing imports and before any function definitions:

1. **Import os** (already imported) and **import datetime** at the top of the file.

2. **VALIDATE_DIMS configuration toggle:**
```python
VALIDATE_DIMS = os.getenv('VALIDATE_DIMS', 'true').lower() == 'true'
```

3. **Dimension constants** (add after VALIDATE_DIMS):
```python
# Dimension constants - FastESM2_650 migration
DNA_DIM = 768       # DNABERT-S embedding dimension (unchanged)
PROTEIN_DIM = 1280  # FastESM2_650 embedding dimension (was 2560 for ESM2 3B)
MERGED_DIM = 2048   # DNA_DIM + PROTEIN_DIM (was 3328)

# Checkpoint versioning
CHECKPOINT_VERSION = "2.0.0"  # Breaking change from 1.x (ESM2 3B)
```

4. **DimensionError custom exception class:**
Per user decision: custom DimensionError class with standardized attributes (expected_dim, actual_dim, tensor_name, location). Message format: "Dimension mismatch at {location}: Expected {expected_dim}-dim {tensor_name}, got {actual_dim}-dim".

5. **Validation functions:**
- `validate_protein_embeddings(proteins, data)`: Optional check (respects VALIDATE_DIMS). Iterates proteins/data, checks each embedding shape is (PROTEIN_DIM,). Raises DimensionError on mismatch.
- `validate_merge_inputs(nucleotide_tensor, protein_tensor, seq_id)`: Critical path - always runs regardless of VALIDATE_DIMS. Checks nucleotide shape is (DNA_DIM,) and protein shape is (PROTEIN_DIM,). Raises DimensionError on mismatch.
- `validate_merged_output(merged_tensor, seq_id)`: Critical path - always runs. Checks shape is (MERGED_DIM,). Raises DimensionError on mismatch.

See 03-RESEARCH.md for exact implementation patterns. Use the research code examples as the reference implementation.

Do NOT use the OLD_ prefix naming from research - use clean names (DNA_DIM, PROTEIN_DIM, MERGED_DIM) since old code is being replaced, not coexisting.
  </action>
  <verify>
Run: `python -c "from units import DimensionError, DNA_DIM, PROTEIN_DIM, MERGED_DIM, VALIDATE_DIMS, validate_merge_inputs, validate_merged_output, validate_protein_embeddings; print(f'DNA={DNA_DIM}, PROTEIN={PROTEIN_DIM}, MERGED={MERGED_DIM}, VALIDATE={VALIDATE_DIMS}'); print('DimensionError:', DimensionError.__name__)"` -- should print dimensions 768, 1280, 2048 and confirm DimensionError exists.

Run: `python -c "from units import DimensionError; e = DimensionError(1280, 2560, 'test_tensor', 'test_location'); print(str(e)); assert e.expected_dim == 1280; assert e.actual_dim == 2560; print('DimensionError attributes OK')"` -- should print formatted error message with all attributes.
  </verify>
  <done>
DimensionError class exists with expected_dim, actual_dim, tensor_name, location attributes. Constants DNA_DIM=768, PROTEIN_DIM=1280, MERGED_DIM=2048, CHECKPOINT_VERSION="2.0.0" are importable from units. VALIDATE_DIMS defaults to True. Three validation functions importable and callable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update merge_data() with dimension validation at inputs and outputs</name>
  <files>units.py</files>
  <action>
Update the existing merge_data() function (currently at line 475 of units.py) to add dimension validation:

1. **Before torch.cat()**: Call `validate_merge_inputs(nucleotide_data, protein_data, item)` to validate both input tensors have correct dimensions. This is a critical path validation that always runs.

2. **After torch.cat()**: Call `validate_merged_output(merged_feature, item)` to validate the concatenated tensor is exactly MERGED_DIM (2048).

The merge_data() function signature and overall behavior remain unchanged. The only additions are the two validation calls inside the loop where nucleotide and protein data are concatenated.

Keep the existing warning print for items not found in both datasets.

Per user decision: merge point validation is critical path and always runs (even when VALIDATE_DIMS=false). The validate_merge_inputs() and validate_merged_output() functions already enforce this.

Also update the existing validate_embeddings() function (currently at line 265) to use the PROTEIN_DIM constant instead of the hardcoded default `expected_dim=1280` parameter. Change the default to `expected_dim=PROTEIN_DIM`.
  </action>
  <verify>
Run: `python -c "
import torch
from units import merge_data, DimensionError, DNA_DIM, PROTEIN_DIM, MERGED_DIM
import tempfile, os

# Create test data with CORRECT dimensions
dna_data = {'nucleotide': ['seq1', 'seq2'], 'data': [{'mean_representation': torch.randn(DNA_DIM).tolist()}, {'mean_representation': torch.randn(DNA_DIM).tolist()}]}
protein_data = {'proteins': ['seq1', 'seq2'], 'data': [torch.randn(PROTEIN_DIM), torch.randn(PROTEIN_DIM)]}

with tempfile.NamedTemporaryFile(suffix='.pt', delete=False) as f1:
    torch.save(dna_data, f1.name)
    dna_file = f1.name
with tempfile.NamedTemporaryFile(suffix='.pt', delete=False) as f2:
    torch.save(protein_data, f2.name)
    protein_file = f2.name
with tempfile.NamedTemporaryFile(suffix='.pt', delete=False) as f3:
    merged_file = f3.name

merge_data(dna_file, protein_file, merged_file)
result = torch.load(merged_file)
assert result['data'].shape[1] == MERGED_DIM, f'Expected {MERGED_DIM}, got {result[\"data\"].shape[1]}'
print(f'merge_data() produces {result[\"data\"].shape[1]}-dim features - CORRECT')

os.unlink(dna_file)
os.unlink(protein_file)
os.unlink(merged_file)
print('All merge_data() validation tests passed')
"` -- should confirm 2048-dim merged output.

Test dimension mismatch detection: `python -c "
import torch
from units import merge_data, DimensionError, DNA_DIM
import tempfile, os

# Create test data with WRONG protein dimensions (old ESM2 3B size)
dna_data = {'nucleotide': ['seq1'], 'data': [{'mean_representation': torch.randn(DNA_DIM).tolist()}]}
protein_data = {'proteins': ['seq1'], 'data': [torch.randn(2560)]}  # Wrong dim!

with tempfile.NamedTemporaryFile(suffix='.pt', delete=False) as f1:
    torch.save(dna_data, f1.name)
    dna_file = f1.name
with tempfile.NamedTemporaryFile(suffix='.pt', delete=False) as f2:
    torch.save(protein_data, f2.name)
    protein_file = f2.name

try:
    merge_data(dna_file, protein_file, '/tmp/should_not_exist.pt')
    print('ERROR: Should have raised DimensionError!')
except DimensionError as e:
    print(f'Correctly caught dimension mismatch: {e}')
    assert e.expected_dim == 1280
    assert e.actual_dim == 2560

os.unlink(dna_file)
os.unlink(protein_file)
print('Dimension mismatch detection works correctly')
"` -- should catch DimensionError for 2560-dim protein embedding.
  </verify>
  <done>
merge_data() validates input dimensions before torch.cat() and output dimensions after. Correct 768+1280 inputs produce 2048-dim merged output. Mismatched dimensions (e.g., old 2560-dim protein embeddings) immediately raise DimensionError with clear message showing expected vs actual dimensions. DIM-01 and DIM-02 requirements satisfied.
  </done>
</task>

</tasks>

<verification>
1. All constants importable: `from units import DNA_DIM, PROTEIN_DIM, MERGED_DIM, CHECKPOINT_VERSION`
2. DimensionError importable with correct attributes
3. Validation functions importable and callable
4. merge_data() with correct dimensions produces 2048-dim output
5. merge_data() with wrong dimensions raises DimensionError
6. VALIDATE_DIMS toggle defaults to True
7. No existing tests broken (existing validate_embeddings still works)
</verification>

<success_criteria>
- DimensionError class with expected_dim, actual_dim, tensor_name, location attributes
- Constants: DNA_DIM=768, PROTEIN_DIM=1280, MERGED_DIM=2048, CHECKPOINT_VERSION="2.0.0"
- VALIDATE_DIMS env var toggle (defaults to true)
- merge_data() produces exactly 2048-dim merged features
- merge_data() raises DimensionError on dimension mismatch at inputs
- Critical path validations always run regardless of VALIDATE_DIMS
</success_criteria>

<output>
After completion, create `.planning/phases/03-dimension-compatibility/03-01-SUMMARY.md`
</output>
