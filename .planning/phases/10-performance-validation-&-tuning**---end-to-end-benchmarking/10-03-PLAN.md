---
phase: 10-performance-validation-tuning
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Full pipeline completes on 1M subset with 2x RTX 4090 in <30 minutes"
    - "Multi-GPU scaling efficiency >= 95% (1.9x+ speedup over single GPU)"
    - "v2.0 achieves >= 4.0x speedup over v1.0 baseline (3.5 hours)"
    - "GPU utilization >80% during ESM-2 embedding step on both GPUs"
    - "Packing efficiency >90% maintained on production workload"
    - "All Phase 10 success criteria documented with pass/fail"
  artifacts: []
  key_links:
    - from: "2x GPU pipeline run"
      to: "1x GPU baseline (Plan 02)"
      via: "scaling efficiency calculation"
      pattern: "scaling_efficiency = time_1gpu / time_2gpu"
    - from: "2x GPU pipeline run"
      to: "v1.0 baseline (3.5 hours)"
      via: "speedup calculation"
      pattern: "speedup = 12600 / time_2gpu"
---

<objective>
Run the full v2.0 pipeline on the real 1M subset dataset with 2x RTX 4090, measure multi-GPU scaling efficiency, compute speedup over v1.0, and produce a final pass/fail report against all Phase 10 success criteria.

Purpose: This is the final benchmark run that validates multi-GPU scaling (>=1.9x speedup, 95% efficiency) and the overall project speedup over v1.0 (>=4.0x, baseline 3.5 hours). Combined with Plan 02 results, this completes all Phase 10 success criteria validation.

Output: Complete 2x GPU benchmark with scaling analysis, v1.0 speedup calculation, and comprehensive pass/fail report.
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-performance-validation-&-tuning**---end-to-end-benchmarking/10-01-SUMMARY.md
@.planning/phases/10-performance-validation-&-tuning**---end-to-end-benchmarking/10-02-SUMMARY.md
@virnucpro/cli/predict.py
@virnucpro/pipeline/prediction.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full pipeline on 1M subset with 2x RTX 4090</name>
  <files></files>
  <action>
Run the complete v2.0 prediction pipeline on the real 1M subset FASTA using both RTX 4090 GPUs. This exercises ALL 9 pipeline stages with multi-GPU parallelism for ESM-2 (Stage 6) and DNABERT-S (Stage 5).

**Input FASTA:**
`/data/Broad_Viral_Respiratory/data/in/raw/full/USA-MA-Broad_MGH-22989-2024.lNDM_F11.HLWLWDRX5.1.hs_depleted.subset_1M.fasta`

**Output directory:**
`/tmp/virnucpro_bench_2gpu/`

**Command:**
```bash
python -m virnucpro predict \
  /data/Broad_Viral_Respiratory/data/in/raw/full/USA-MA-Broad_MGH-22989-2024.lNDM_F11.HLWLWDRX5.1.hs_depleted.subset_1M.fasta \
  -o /tmp/virnucpro_bench_2gpu \
  --force \
  --keep-intermediate \
  --parallel \
  2>&1 | tee /tmp/virnucpro_bench_2gpu_log.txt
```

Note: With `--parallel` and no `--gpus`, the CLI auto-detects both GPUs and enables parallel mode. ESM-2 uses v2.0 async architecture (2 GPU workers with stride-based sharding). DNABERT-S uses v1.0 parallel (multi-worker with bin-packing).

**Expected behavior:**
- 1M input sequences -> ~600K translated sequences after 6-frame translation
- Per-stage timing logged via PipelineTelemetry (from Plan 01)
- ESM-2 runs on 2 GPUs simultaneously (v2.0 stride-based sharding)
- DNABERT-S runs on 2 GPUs simultaneously (v1.0 bin-packing)
- Pipeline summary block printed at completion
- Total time target: <30 minutes (1800 seconds)

**Timeout:** Set bash timeout to 3600 seconds (60 minutes). If the command exceeds this, it indicates a performance problem.

**After the run completes, extract and record:**
1. Total wall time from the summary block
2. Per-stage timing breakdown from the summary block
3. ESM-2 stage timing specifically
4. Whether the <30 minutes target was met
5. Any errors or warnings in the log
  </action>
  <verify>
1. Check exit code (should be 0)
2. Verify output files exist: `/tmp/virnucpro_bench_2gpu/*_merged/prediction_results.txt` and `prediction_results_highestscore.csv`
3. Check total wall time from log: `grep "Total wall time" /tmp/virnucpro_bench_2gpu_log.txt`
4. Check per-stage breakdown: `grep -A 15 "PIPELINE SUMMARY" /tmp/virnucpro_bench_2gpu_log.txt`
  </verify>
  <done>Full pipeline completes on 1M subset with 2x RTX 4090. Total wall time and per-stage breakdown recorded.</done>
</task>

<task type="auto">
  <name>Task 2: Compute scaling efficiency, v1.0 speedup, and compile final report</name>
  <files></files>
  <action>
Using the results from Plan 02 (1x GPU) and Task 1 (2x GPU), compute all Phase 10 success metrics and produce a comprehensive pass/fail report.

**Metrics to compute:**

1. **Multi-GPU Scaling Efficiency:**
   - `scaling_speedup = time_1gpu / time_2gpu`
   - `scaling_efficiency = scaling_speedup / 2.0` (ideal is 1.0 = 100%)
   - Target: scaling_speedup >= 1.9 (95% efficiency)
   - Note: Only ESM-2 and DNABERT-S stages benefit from multi-GPU. CPU-bound stages (translation, merging, prediction, consensus) run identically on 1 vs 2 GPUs. So compute GPU-stage-only scaling too:
     - `esm2_scaling = esm2_time_1gpu / esm2_time_2gpu`
     - `dnabert_scaling = dnabert_time_1gpu / dnabert_time_2gpu`

2. **v1.0 Speedup:**
   - v1.0 baseline: 3.5 hours = 12600 seconds on 2x RTX 4090
   - `speedup = 12600 / time_2gpu`
   - Target: >= 4.0x

3. **Time Targets:**
   - 1x RTX 4090: < 3600 seconds (1 hour) — from Plan 02
   - 2x RTX 4090: < 1800 seconds (30 minutes) — from Task 1

4. **Correctness:**
   - Consensus label agreement >= 99% — from Plan 02 Task 2
   - (Run a quick sanity comparison of 2-GPU output too to confirm consistency):
   ```bash
   python compare_virnucpro_outputs.py \
     --vanilla /data/Broad_Viral_Respiratory/data/in/raw/full/USA-MA-Broad_MGH-22989-2024.lNDM_F11.HLWLWDRX5.1.hs_depleted.subset_1M_merged/prediction_results_highestscore.csv \
     --refactored /tmp/virnucpro_bench_2gpu/*_merged/prediction_results_highestscore.csv \
     --mode consensus \
     --tolerance 0.01
   ```

5. **GPU Utilization:**
   - Target: >80% during embedding steps
   - Extract from log: GPU utilization metrics logged by NvitopMonitor during ESM-2 and DNABERT-S stages
   - Check log for utilization reports: `grep -i "gpu.*util\|utilization" /tmp/virnucpro_bench_2gpu_log.txt`

6. **Packing Efficiency:**
   - Target: >90%
   - Extract from log: Packing efficiency logged by AsyncInferenceRunner
   - Check log: `grep -i "packing.*efficiency\|pack.*eff" /tmp/virnucpro_bench_2gpu_log.txt`

**Produce a comprehensive report** (printed to stdout) with this format:

```
================================================================================
PHASE 10: PERFORMANCE VALIDATION RESULTS
================================================================================

TIMING
  1x RTX 4090:  XX:XX (target: <1 hour)        [PASS/FAIL]
  2x RTX 4090:  XX:XX (target: <30 min)         [PASS/FAIL]

SCALING
  Multi-GPU speedup:      X.XXx (target: >=1.9x)     [PASS/FAIL]
  Scaling efficiency:     XX.X% (target: >=95%)       [PASS/FAIL]
  ESM-2 scaling:          X.XXx
  DNABERT-S scaling:      X.XXx

SPEEDUP vs v1.0
  v1.0 baseline (2x 4090): 3:30:00 (known)
  v2.0 result (2x 4090):   XX:XX
  Speedup:                  X.Xx (target: >=4.0x)     [PASS/FAIL]

CORRECTNESS
  Consensus label agreement: XX.XX% (target: >=99%)   [PASS/FAIL]
  Per-frame label agreement: XX.XX%
  Score tolerance: 0.01

GPU METRICS
  GPU utilization (ESM-2):  XX% (target: >80%)        [PASS/FAIL]
  Packing efficiency:       XX% (target: >90%)        [PASS/FAIL]

PER-STAGE BREAKDOWN (2x RTX 4090)
  Stage 1: Sequence Chunking ........  XXs (X.X%)
  Stage 2: Six-Frame Translation ....  XXs (X.X%)
  Stage 3: Nucleotide Splitting .....  XXs (X.X%)
  Stage 4: Protein Splitting ........  XXs (X.X%)
  Stage 5: DNABERT-S .................  XXs (X.X%)
  Stage 6: ESM-2 ....................  XXs (X.X%)
  Stage 7: Feature Merging ..........  XXs (X.X%)
  Stage 8: Model Prediction .........  XXs (X.X%)
  Stage 9: Consensus Scoring ........  XXs (X.X%)

OVERALL: [ALL CRITERIA MET / X of Y CRITERIA MET]
================================================================================
```

Record all metrics clearly. These are the final numbers for the project.
  </action>
  <verify>
1. All 7 success criteria have pass/fail determinations
2. Scaling efficiency calculated correctly from 1-GPU and 2-GPU times
3. v1.0 speedup calculated correctly from 12600 seconds baseline
4. 2-GPU correctness comparison completed
5. GPU utilization and packing efficiency extracted from logs
  </verify>
  <done>Comprehensive Phase 10 validation report produced with pass/fail for all criteria: time targets, scaling, speedup, correctness, GPU utilization, packing efficiency.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 10 validation: 1x and 2x RTX 4090 benchmarks on the real 1M subset dataset, correctness validation against v1.0, multi-GPU scaling analysis, and v1.0 speedup calculation. All results compiled into a comprehensive pass/fail report.
  </what-built>
  <how-to-verify>
Review the Phase 10 validation report:

1. **All criteria met?** Check each pass/fail line:
   - 1x 4090 < 1 hour?
   - 2x 4090 < 30 minutes?
   - Multi-GPU scaling >= 1.9x?
   - v1.0 speedup >= 4.0x?
   - Consensus label agreement >= 99%?
   - GPU utilization > 80%?
   - Packing efficiency > 90%?

2. **If all pass:** Phase 10 is complete. The v2.0 async architecture delivers the required performance.

3. **If any fail:** Review which criteria failed and whether:
   - The target needs adjustment (was it realistic?)
   - Parameter tuning could help (DataLoader workers, token budget, prefetch factor)
   - A code fix is needed (bug found during benchmark)

4. **Per-stage breakdown:** Is ESM-2 still the bottleneck? What percentage of total time is non-GPU work (translation, merging, prediction)?

5. **Decision:** Mark Phase 10 as complete or identify specific follow-up work.
  </how-to-verify>
  <resume-signal>Type "approved" if all criteria met and Phase 10 is complete, or describe issues/adjustments needed</resume-signal>
</task>

</tasks>

<verification>
1. Full pipeline completed successfully with 2x RTX 4090
2. Total wall time < 1800 seconds (30 minutes)
3. Multi-GPU scaling speedup >= 1.9x over single GPU
4. v1.0 speedup >= 4.0x (based on 12600s baseline)
5. 2-GPU output also has >= 99% consensus label agreement with v1.0
6. GPU utilization > 80% during embedding steps
7. Packing efficiency > 90% on production workload
8. Comprehensive pass/fail report produced for all criteria
</verification>

<success_criteria>
- All 7 Phase 10 success criteria validated with pass/fail
- 2x RTX 4090 completes 1M subset in < 30 minutes
- Multi-GPU scaling >= 1.9x with 95% efficiency
- v2.0 achieves >= 4.0x speedup over v1.0 (3.5h baseline)
- Final validation report compiled with all metrics
</success_criteria>

<output>
After completion, create `.planning/phases/10-performance-validation-&-tuning**---end-to-end-benchmarking/10-03-SUMMARY.md`
</output>
