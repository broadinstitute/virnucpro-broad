---
phase: 04.1-persistent-model-loading
plan: 02
subsystem: pipeline
tags: [multiprocessing, pytorch, gpu, memory-management, persistent-workers, esm2, dnabert]

# Dependency graph
requires:
  - phase: 04.1-01
    provides: PersistentWorkerPool infrastructure
provides:
  - Persistent worker functions for ESM-2 (init_esm_worker, process_esm_files_persistent)
  - Persistent worker functions for DNABERT-S (init_dnabert_worker, process_dnabert_files_persistent)
  - Model caching in module globals for worker lifetime
  - Periodic cache clearing for fragmentation prevention
affects: [04.1-03, future-pipeline-optimization]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Module-level globals for model persistence across tasks"
    - "Worker initializer with model pre-loading"
    - "Periodic CUDA cache clearing every 10 files"
    - "Expandable segments configuration in worker init"

key-files:
  created: []
  modified:
    - virnucpro/pipeline/parallel_esm.py
    - virnucpro/pipeline/parallel_dnabert.py

key-decisions:
  - "Module globals for model storage allows workers to reuse models across multiple tasks"
  - "Periodic cache clearing every 10 files prevents fragmentation in long-running workers"
  - "Expandable segments configured before any CUDA operations to optimize memory allocation"

patterns-established:
  - "Pattern: Worker initializer loads model once, process function reuses model from globals"
  - "Pattern: Periodic cache clearing (every N files) balances overhead vs fragmentation prevention"

# Metrics
duration: 3min
completed: 2026-01-24
---

# Phase 04.1 Plan 02: Persistent Worker Functions Summary

**ESM-2 and DNABERT-S persistent worker functions with model caching, periodic cache clearing, and backward compatibility**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-24T06:30:28Z
- **Completed:** 2026-01-24T06:33:05Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Added persistent worker functions for ESM-2 with model pre-loading
- Added persistent worker functions for DNABERT-S with model pre-loading
- Implemented module-level globals for model storage (_esm_model, _batch_converter, _device for ESM-2; _dnabert_model, _tokenizer, _device for DNABERT-S)
- Configured expandable_segments BEFORE any CUDA operations in worker initializers
- Implemented periodic cache clearing every 10 files to prevent fragmentation
- Maintained complete backward compatibility with existing worker functions

## Task Commits

Each task was committed atomically:

1. **Task 1: Add persistent ESM-2 worker functions** - `26d495c` (feat)
2. **Task 2: Add persistent DNABERT-S worker functions** - `7250868` (feat)

## Files Created/Modified

- `virnucpro/pipeline/parallel_esm.py` - Added init_esm_worker() and process_esm_files_persistent() functions (206 lines added)
- `virnucpro/pipeline/parallel_dnabert.py` - Added init_dnabert_worker() and process_dnabert_files_persistent() functions (307 lines added)

## Decisions Made

**1. Module-level globals for model storage**
- **Context:** Workers need to share model across multiple task invocations
- **Decision:** Use module-level globals (_esm_model, _batch_converter, _device) set during init
- **Rationale:** Module globals persist for worker process lifetime, avoiding repeated model loads
- **Impact:** Workers can process multiple file batches without reloading models

**2. Periodic cache clearing every 10 files**
- **Context:** Long-running workers accumulate fragmented CUDA memory
- **Decision:** Call torch.cuda.empty_cache() every 10 files processed
- **Rationale:** Consistent with Phase 04.1-01 decision, balances overhead vs fragmentation
- **Impact:** Prevents OOM errors in long-running workers without excessive clearing overhead

**3. Expandable segments before CUDA operations**
- **Context:** Memory fragmentation requires proper configuration timing
- **Decision:** Set PYTORCH_CUDA_ALLOC_CONF='expandable_segments:True' BEFORE torch.device() call
- **Rationale:** Environment variable must be set before first CUDA context initialization
- **Impact:** Enables expandable segments memory allocator for better fragmentation handling

**4. Backward compatibility maintained**
- **Context:** Existing pipeline code uses process_esm_files_worker and process_dnabert_files_worker
- **Decision:** Keep existing functions unchanged, add new persistent functions separately
- **Rationale:** Allows gradual adoption, prevents breaking existing code
- **Impact:** Existing code continues to work, new code can opt into persistent workers

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - implementation proceeded smoothly following established patterns from Phase 04.1-01.

## User Setup Required

None - functions ready to use with PersistentWorkerPool from Phase 04.1-01.

## Next Phase Readiness

**Ready for next plan:**
- Persistent worker functions implemented for both ESM-2 and DNABERT-S
- Model loading in initializer, reuse in worker function
- Periodic cache clearing prevents fragmentation
- Module globals store models for worker lifetime
- Backward compatibility maintained with existing workers

**Next steps:**
- Integrate persistent workers into BatchQueueManager
- Test persistent worker performance vs traditional workers
- Measure model loading overhead savings
- Benchmark memory fragmentation prevention

**No blockers or concerns** - persistent worker functions ready for integration and testing.

---
*Phase: 04.1-persistent-model-loading*
*Completed: 2026-01-24*
