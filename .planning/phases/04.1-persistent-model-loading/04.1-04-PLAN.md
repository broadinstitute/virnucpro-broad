---
phase: 04.1-persistent-model-loading
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [virnucpro/pipeline/features.py, virnucpro/pipeline/persistent_pool.py]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Feature extraction functions accept pre-loaded models as optional parameters"
    - "Worker processes pass pre-loaded models to extraction functions"
    - "Models are loaded once and reused across all files"
  artifacts:
    - path: "virnucpro/pipeline/features.py"
      provides: "Refactored extraction functions with optional model parameters"
      exports: ["extract_dnabert_features", "extract_esm_features"]
    - path: "virnucpro/pipeline/persistent_pool.py"
      provides: "Updated worker functions that pass models correctly"
      min_lines: 450
  key_links:
    - from: "persistent_pool.py"
      to: "features.py"
      via: "passes pre-loaded models to extraction functions"
      pattern: "extract_(esm|dnabert)_features.*model="
---

<objective>
Refactor feature extraction functions to accept pre-loaded models, eliminating redundant model loading.

Purpose: Close the critical gap where models are loaded twice - once in persistent workers and again in extraction functions, defeating the purpose of persistence.
Output: Modified extraction functions that can use pre-loaded models when provided, maintaining backward compatibility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04.1-persistent-model-loading/04.1-VERIFICATION.md

# Key files to modify
@virnucpro/pipeline/features.py
@virnucpro/pipeline/persistent_pool.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor extract_dnabert_features to accept pre-loaded model</name>
  <files>virnucpro/pipeline/features.py</files>
  <action>
    Modify extract_dnabert_features() to accept optional pre-loaded model and tokenizer parameters.

    Changes to make:
    - Add optional parameters: model=None, tokenizer=None
    - Only load model/tokenizer if not provided (backward compatibility)
    - Use provided model/tokenizer if available
    - Ensure model is in eval mode whether loaded or provided

    Implementation pattern:
    ```python
    def extract_dnabert_features(nucleotide_file, output_file, device,
                                batch_size=256, model=None, tokenizer=None):
        # ... existing imports ...

        # Only load if not provided
        if model is None or tokenizer is None:
            model_name = "zhihan1996/DNABERT-S"
            if tokenizer is None:
                tokenizer = AutoTokenizer.from_pretrained(model_name, trust_remote_code=True)
            if model is None:
                model = AutoModel.from_pretrained(model_name, trust_remote_code=True).to(device)
        else:
            # Ensure provided model is on correct device
            model = model.to(device)

        model.eval()
        # ... rest of function unchanged ...
    ```

    This maintains backward compatibility while allowing persistent workers to pass pre-loaded models.
  </action>
  <verify>grep -n "def extract_dnabert_features.*model=" virnucpro/pipeline/features.py</verify>
  <done>extract_dnabert_features accepts optional model and tokenizer parameters</done>
</task>

<task type="auto">
  <name>Task 2: Refactor extract_esm_features to accept pre-loaded model</name>
  <files>virnucpro/pipeline/features.py</files>
  <action>
    Modify extract_esm_features() to accept optional pre-loaded model and batch_converter parameters.

    Changes to make:
    - Add optional parameters: model=None, batch_converter=None
    - Only call load_esm2_model if not provided (backward compatibility)
    - Use provided model/batch_converter if available
    - Handle BF16 detection from provided model

    Implementation pattern:
    ```python
    def extract_esm_features(protein_file, output_file, device,
                            toks_per_batch=2048, truncation_length=1024,
                            stream_processor=None, model=None, batch_converter=None):
        # ... existing imports ...

        # Only load if not provided
        if model is None or batch_converter is None:
            model, batch_converter = load_esm2_model(
                model_name="esm2_t36_3B_UR50D",
                device=str(device),
                logger_instance=logger
            )
        else:
            # Ensure provided model is on correct device
            model = model.to(device)

        # Get BF16 status (model wrapper has this attribute)
        use_bf16 = getattr(model, 'use_bf16', False)

        # ... rest of function unchanged ...
    ```

    This maintains backward compatibility while allowing persistent workers to pass pre-loaded models.
  </action>
  <verify>grep -n "def extract_esm_features.*model=" virnucpro/pipeline/features.py</verify>
  <done>extract_esm_features accepts optional model and batch_converter parameters</done>
</task>

<task type="auto">
  <name>Task 3: Update persistent pool to pass pre-loaded models</name>
  <files>virnucpro/pipeline/persistent_pool.py</files>
  <action>
    Update process_files_persistent() to pass pre-loaded models to extraction functions.

    Changes to make in process_files_persistent():

    For ESM-2 processing (around lines 176-187):
    - Remove the warning about "not yet refactored"
    - Pass _model and _batch_converter to extract_esm_features

    ```python
    # Process file using cached model
    if _model_type == 'esm2':
        output_file = output_dir / f"{file.stem}_ESM.pt"
        toks_per_batch = kwargs.get('toks_per_batch', 2048)
        stream_processor = kwargs.get('stream_processor', None)

        from virnucpro.pipeline.features import extract_esm_features
        # Pass pre-loaded model and batch_converter
        extract_esm_features(
            file,
            output_file,
            _device,
            toks_per_batch=toks_per_batch,
            stream_processor=stream_processor,
            model=_model,  # Pass pre-loaded model
            batch_converter=_batch_converter  # Pass pre-loaded batch_converter
        )
    ```

    For DNABERT processing (around lines 189-203):
    - Remove the warning about "not yet refactored"
    - Pass _model and _tokenizer to extract_dnabert_features

    ```python
    elif _model_type == 'dnabert':
        output_file = output_dir / f"{file.stem}_DNABERT.pt"
        batch_size = kwargs.get('batch_size', 256)

        from virnucpro.pipeline.features import extract_dnabert_features
        # Pass pre-loaded model and tokenizer
        extract_dnabert_features(
            file,
            output_file,
            _device,
            batch_size=batch_size,
            model=_model,  # Pass pre-loaded model
            tokenizer=_tokenizer  # Pass pre-loaded tokenizer
        )
    ```

    Also add logging to confirm models are reused:
    - After _load_model_lazy(), add: logger.info(f"Worker {device_id}: Using pre-loaded {_model_type} model")
  </action>
  <verify>grep -n "model=_model" virnucpro/pipeline/persistent_pool.py && grep -v "not yet refactored" virnucpro/pipeline/persistent_pool.py | grep -c "not yet refactored" | grep "^0$"</verify>
  <done>Persistent pool passes pre-loaded models to extraction functions, warnings removed</done>
</task>

</tasks>

<verification>
- Feature extraction functions can now accept pre-loaded models
- Persistent workers pass their cached models to extraction functions
- Models are loaded once per worker and reused for all files
- Backward compatibility maintained for standard (non-persistent) usage
</verification>

<success_criteria>
- extract_dnabert_features and extract_esm_features accept optional model parameters
- process_files_persistent passes pre-loaded models to extraction functions
- No more "not yet refactored" warnings in logs
- Models are NOT reloaded for each file when using persistent workers
</success_criteria>

<output>
After completion, create `.planning/phases/04.1-persistent-model-loading/04.1-04-SUMMARY.md`
</output>