---
phase: 11-code-quality-foundations
plan: 05
type: execute
wave: 3
depends_on: ["11-01", "11-03", "11-04"]
files_modified:
  - virnucpro/utils/precision.py
  - virnucpro/pipeline/checkpoint_writer.py
  - virnucpro/models/esm2_flash.py
  - virnucpro/cli/predict.py
autonomous: true

must_haves:
  truths:
    - "All os.getenv/os.environ.get calls for VIRNUCPRO_* env vars replaced with EnvConfig access"
    - "should_use_fp16() in precision.py delegates to EnvConfig"
    - "VIRNUCPRO_V1_ATTENTION in esm2_flash.py uses EnvConfig"
    - "VIRNUCPRO_VIRAL_CHECKPOINT_MODE in checkpoint_writer.py uses EnvConfig"
    - "predict.py calls get_env_config.cache_clear() after setting VIRNUCPRO_* env vars"
    - "No circular imports between env_config, pipeline, models, and utils modules"
    - "All existing tests pass (full test suite, not just unit tests)"
  artifacts:
    - path: "virnucpro/utils/precision.py"
      provides: "FP16 check via EnvConfig"
      contains: "get_env_config"
    - path: "virnucpro/models/esm2_flash.py"
      provides: "V1 attention check via EnvConfig"
      contains: "get_env_config"
    - path: "virnucpro/pipeline/checkpoint_writer.py"
      provides: "Viral checkpoint mode via EnvConfig"
      contains: "get_env_config"
    - path: "virnucpro/cli/predict.py"
      provides: "Cache invalidation after env var writes"
      contains: "cache_clear"
  key_links:
    - from: "virnucpro/utils/precision.py"
      to: "virnucpro/core/env_config.py"
      via: "get_env_config().disable_fp16"
      pattern: "get_env_config"
    - from: "virnucpro/models/esm2_flash.py"
      to: "virnucpro/core/env_config.py"
      via: "get_env_config().v1_attention"
      pattern: "get_env_config"
---

<objective>
Migrate all remaining VIRNUCPRO_* environment variable access sites to use EnvConfig, then validate the full test suite passes.

Purpose: Completes QUAL-01 (all env vars centralized). Plans 03 and 04 already migrated async_inference.py and gpu_worker.py. This plan handles the remaining 4 files with VIRNUCPRO_* env var access. Non-VIRNUCPRO env vars (CUDA_VISIBLE_DEVICES, PYTORCH_CUDA_ALLOC_CONF, TOKENIZERS_PARALLELISM) that are SET (not read) remain as direct os.environ assignments since they control external tool behavior, not application config.

Output: All VIRNUCPRO_* reads use EnvConfig. Full test suite passes.
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@virnucpro/core/env_config.py (EnvConfig from Plan 01)
@.planning/phases/11-code-quality-foundations/11-01-SUMMARY.md
@.planning/phases/11-code-quality-foundations/11-03-SUMMARY.md
@.planning/phases/11-code-quality-foundations/11-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate remaining VIRNUCPRO_* env var reads to EnvConfig</name>
  <files>
    virnucpro/utils/precision.py
    virnucpro/pipeline/checkpoint_writer.py
    virnucpro/models/esm2_flash.py
    virnucpro/cli/predict.py
  </files>
  <action>
    Migrate the remaining 3 files that read VIRNUCPRO_* environment variables:

    **1. virnucpro/utils/precision.py (line 36)**
    Current:
    ```python
    disable = os.getenv("VIRNUCPRO_DISABLE_FP16", "").strip().lower() in ("1", "true", "yes")
    ```
    Replace with:
    ```python
    from virnucpro.core.env_config import get_env_config
    env = get_env_config()
    disable = env.disable_fp16
    ```
    Keep the warning log message unchanged. Remove the `import os` if no longer needed (check for other os usage in the file first).

    **2. virnucpro/pipeline/checkpoint_writer.py (line 87)**
    Current:
    ```python
    viral_mode = os.environ.get('VIRNUCPRO_VIRAL_CHECKPOINT_MODE', '').lower() == 'true'
    ```
    Replace with:
    ```python
    from virnucpro.core.env_config import get_env_config
    env = get_env_config()
    viral_mode = env.viral_checkpoint_mode
    ```

    **3. virnucpro/models/esm2_flash.py (line 209)**
    Current:
    ```python
    _use_v1_attention = v1_compatible or os.environ.get('VIRNUCPRO_V1_ATTENTION', '').lower() == 'true'
    ```
    Replace with:
    ```python
    from virnucpro.core.env_config import get_env_config
    env = get_env_config()
    _use_v1_attention = v1_compatible or env.v1_attention
    ```

    **4. virnucpro/cli/predict.py (line 276)**
    predict.py is the CLI policy layer that SETS env vars (e.g., `os.environ['VIRNUCPRO_V1_ATTENTION'] = 'true'`)
    before the implementation layer reads them. After setting env vars, predict.py must invalidate
    the EnvConfig cache so subsequent get_env_config() calls pick up the new values:
    ```python
    from virnucpro.core.env_config import get_env_config
    # After setting VIRNUCPRO_* env vars:
    os.environ['VIRNUCPRO_V1_ATTENTION'] = 'true'
    get_env_config.cache_clear()  # Invalidate so next access sees updated value
    ```
    This prevents the race condition where EnvConfig was cached before predict.py set its env vars.
    Add this cache_clear() call after ALL env var WRITES in predict.py, not after each individual one.

    **Files NOT migrated (intentionally):**
    - `virnucpro/data/dataloader_utils.py`: Sets CUDA_VISIBLE_DEVICES='' and TOKENIZERS_PARALLELISM=false in worker_init_fn. These are WRITES to os.environ for external tool control, not READS of application config.
    - `virnucpro/pipeline/gpu_coordinator.py`: Sets CUDA_VISIBLE_DEVICES for child processes. This is a WRITE.
    - `virnucpro/cuda/memory_manager.py`: Sets PYTORCH_CUDA_ALLOC_CONF. This is a WRITE.
    - `virnucpro/cli/predict.py`: Sets CUDA_VISIBLE_DEVICES and VIRNUCPRO_V1_ATTENTION. These are WRITES (policy layer setting env vars before calling implementation).
    - `virnucpro/pipeline/persistent_pool.py`, `parallel_dnabert.py`, `parallel_esm.py`: Set PYTORCH_CUDA_ALLOC_CONF. These are WRITES.
    - `virnucpro/data/sequence_dataset.py`: Reads CUDA_VISIBLE_DEVICES in validate_cuda_isolation. This is a safety check reading an external env var, not a VIRNUCPRO_* config var.

    The distinction: EnvConfig centralizes READS of VIRNUCPRO_* application config. WRITES to os.environ (setting values for child processes or external tools) remain as direct os.environ assignments.
  </action>
  <verify>
    # Verify no more direct VIRNUCPRO_* reads outside EnvConfig
    grep -rn "os\.getenv.*VIRNUCPRO\|os\.environ.*get.*VIRNUCPRO" virnucpro/ --include="*.py" | grep -v env_config.py | grep -v "# WRITE" | grep -v predict.py
    # Should show no matches (predict.py writes, env_config.py is the source)

    pytest tests/unit/test_env_config.py -v -x
    pytest tests/unit/test_async_inference.py tests/unit/test_gpu_worker.py tests/unit/test_collators.py -v -x
  </verify>
  <done>
    All VIRNUCPRO_* env var reads use EnvConfig. Direct os.environ reads only remain for non-VIRNUCPRO vars and WRITE operations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify no regressions</name>
  <files></files>
  <action>
    Run the complete test suite to verify 1:1 behavior equivalence after all Phase 11 refactoring:

    ```bash
    pytest tests/ -v -m "not slow" --tb=short
    ```

    If any tests fail:
    1. Identify the root cause (likely an import path change or missed env var migration)
    2. Fix the issue
    3. Re-run failing tests
    4. Re-run full suite to confirm fix doesn't break other tests

    Also verify the grep audit is clean:
    ```bash
    # All VIRNUCPRO_* reads should go through EnvConfig
    grep -rn "os\.getenv.*VIRNUCPRO\|os\.environ\.get.*VIRNUCPRO" virnucpro/ --include="*.py" | grep -v env_config.py | grep -v predict.py
    # Should return empty (predict.py is policy layer that SETS env vars)

    # No .pop(0) in collators
    grep -rn "\.pop(0)" virnucpro/data/collators.py
    # Should return empty

    # Verify deque usage
    grep -n "deque" virnucpro/data/collators.py
    # Should show import and initialization
    ```

    **Import cycle validation** (Issue 5): Verify no circular imports after all plans:
    ```bash
    python -c "from virnucpro.core.env_config import get_env_config; from virnucpro.pipeline.async_inference import AsyncInferenceRunner; from virnucpro.pipeline.gpu_worker import gpu_worker; from virnucpro.models.esm2_flash import ESM2WithFlashAttention; from virnucpro.utils.precision import should_use_fp16; print('No import cycles')"
    ```

    **Performance benchmarks note**: After all Phase 11 plans complete, performance benchmarks should
    be run to confirm no regression from the refactoring (especially the deque change in collators.py).
    However, do NOT block plan completion on GPU benchmark availability â€” the deque change is O(1) vs
    O(n) and cannot regress performance. Full benchmark validation requires GPU hardware and can be
    done as a post-phase check by the user.
  </action>
  <verify>
    pytest tests/ -v -m "not slow" --tb=short
    # All tests pass

    # Import cycle check
    python -c "from virnucpro.core.env_config import get_env_config; from virnucpro.pipeline.async_inference import AsyncInferenceRunner; from virnucpro.pipeline.gpu_worker import gpu_worker; from virnucpro.models.esm2_flash import ESM2WithFlashAttention; from virnucpro.utils.precision import should_use_fp16; print('No import cycles')"
  </verify>
  <done>
    Full test suite passes. No import cycles. All Phase 11 refactoring is behavior-equivalent. Grep audit confirms centralized env var access and deque migration. Performance benchmarks recommended as post-phase check (requires GPU).
  </done>
</task>

</tasks>

<verification>
pytest tests/ -v -m "not slow" --tb=short
# Full test suite passes

# Audit: no direct VIRNUCPRO_* reads outside EnvConfig
grep -rn "os\.getenv.*VIRNUCPRO\|os\.environ\.get.*VIRNUCPRO" virnucpro/ --include="*.py" | grep -v env_config.py | grep -v predict.py
# Empty output = clean

# Import cycle validation
python -c "from virnucpro.core.env_config import get_env_config; from virnucpro.pipeline.async_inference import AsyncInferenceRunner; from virnucpro.pipeline.gpu_worker import gpu_worker; from virnucpro.models.esm2_flash import ESM2WithFlashAttention; from virnucpro.utils.precision import should_use_fp16; print('No import cycles')"
</verification>

<success_criteria>
- All VIRNUCPRO_* env var reads centralized in EnvConfig
- predict.py calls get_env_config.cache_clear() after setting VIRNUCPRO_* env vars
- No circular imports between env_config, pipeline, models, and utils modules
- Full test suite passes (not just unit tests)
- Grep audit confirms no stray os.getenv/os.environ.get for VIRNUCPRO_* vars
- Phase 11 is complete: QUAL-01 through QUAL-05 all addressed
- Performance benchmarks recommended as post-phase user verification (requires GPU)
</success_criteria>

<output>
After completion, create `.planning/phases/11-code-quality-foundations/11-05-SUMMARY.md`
</output>
