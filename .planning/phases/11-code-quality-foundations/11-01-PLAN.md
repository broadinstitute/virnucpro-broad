---
phase: 11-code-quality-foundations
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - virnucpro/core/env_config.py
  - tests/unit/test_env_config.py
autonomous: true

must_haves:
  truths:
    - "EnvConfig dataclass loads all VIRNUCPRO_* application environment variables from os.environ"
    - "Invalid boolean env var values raise ValueError with descriptive message"
    - "get_env_config() returns cached singleton instance via @lru_cache"
    - "Tests can clear cache via get_env_config.cache_clear() for isolation"
    - "EnvConfig only contains VIRNUCPRO_* vars (not CUDA_VISIBLE_DEVICES, PYTORCH_CUDA_ALLOC_CONF, or TOKENIZERS_PARALLELISM)"
    - "Docstring documents that env vars must be set before first get_env_config() call, or cache_clear() must be called after late-setting"
  artifacts:
    - path: "virnucpro/core/env_config.py"
      provides: "Centralized environment variable access"
      contains: "class EnvConfig"
    - path: "tests/unit/test_env_config.py"
      provides: "Unit tests for EnvConfig"
      contains: "test_"
  key_links:
    - from: "virnucpro/core/env_config.py"
      to: "os.environ"
      via: "__post_init__ loading"
      pattern: "os\\.environ\\.get"
---

<objective>
Create `virnucpro/core/env_config.py` with a flat dataclass that centralizes all environment variable access.

Purpose: Foundation for QUAL-01. All scattered `os.getenv()` / `os.environ.get()` calls (19 sites across 9 files) will eventually route through this single dataclass. This plan creates the dataclass and tests it; migration of call sites happens in Plan 05.

Output: Working `EnvConfig` dataclass with `get_env_config()` factory, tested with TDD.
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@virnucpro/pipeline/runtime_config.py (existing dataclass pattern to follow)
@virnucpro/utils/precision.py (existing env var boolean parsing)
</context>

<feature>
  <name>EnvConfig dataclass with cached factory</name>
  <files>virnucpro/core/env_config.py, tests/unit/test_env_config.py</files>
  <behavior>
    EnvConfig is a flat @dataclass that loads environment variables in __post_init__:

    Environment variables to centralize (VIRNUCPRO_* application config only):
    - VIRNUCPRO_DISABLE_PACKING: bool (default False) — emergency packing rollback
    - VIRNUCPRO_DISABLE_FP16: bool (default False) — FP16 diagnostic rollback
    - VIRNUCPRO_V1_ATTENTION: bool (default False) — v1.0 attention compatibility
    - VIRNUCPRO_VIRAL_CHECKPOINT_MODE: bool (default False) — viral workload checkpoint tuning

    NOT included (these are external tool/runtime vars, not application config):
    - CUDA_VISIBLE_DEVICES: SET by worker_init_fn/gpu_coordinator, READ directly via os.environ in safety checks
    - PYTORCH_CUDA_ALLOC_CONF: SET by workers for CUDA allocator control
    - TOKENIZERS_PARALLELISM: SET by worker_init_fn for HuggingFace tokenizers
    - VIRNUCPRO_DISABLE_COMPILE / VIRNUCPRO_COMPILE_MODEL: Does not exist in codebase yet (future Phase 15)

    Boolean parsing: accept ("1", "true", "yes") for True, ("0", "false", "no", "") for False.
    Invalid values (e.g., "banana"): raise ValueError with descriptive message.

    NOTE on "standardization": In this phase, "standardize naming" means standardized PARSING
    (all boolean env vars accept the same set of values: true/false/1/0/yes/no). Existing env var
    NAMES are kept as-is. If renaming is desired, that would be a separate concern in a future phase.

    Factory: get_env_config() decorated with @lru_cache(maxsize=1) returns singleton.
    Tests clear cache via get_env_config.cache_clear().

    Cache invalidation pattern: When code (like predict.py CLI layer) sets env vars at runtime
    AFTER get_env_config() has already been called, it must call get_env_config.cache_clear()
    so the next get_env_config() call picks up the new values. Document this in the module
    docstring and get_env_config() docstring.

    Test cases:
    - Default values when no env vars set -> all bools False
    - VIRNUCPRO_DISABLE_PACKING=true -> disable_packing == True
    - VIRNUCPRO_DISABLE_PACKING=1 -> disable_packing == True
    - VIRNUCPRO_DISABLE_PACKING=yes -> disable_packing == True
    - VIRNUCPRO_DISABLE_PACKING=false -> disable_packing == False
    - VIRNUCPRO_DISABLE_PACKING=0 -> disable_packing == False
    - VIRNUCPRO_DISABLE_PACKING=banana -> raises ValueError
    - VIRNUCPRO_DISABLE_FP16=TRUE (uppercase) -> disable_fp16 == True
    - get_env_config() returns same instance (cached)
    - get_env_config.cache_clear() allows new instance
    - Cache invalidation: set env var, cache_clear(), get_env_config() sees new value
    - EnvConfig has exactly 4 fields (disable_packing, disable_fp16, v1_attention, viral_checkpoint_mode)
  </behavior>
  <implementation>
    Follow the RuntimeConfig pattern in virnucpro/pipeline/runtime_config.py:
    - @dataclass with typed fields and defaults
    - __post_init__ for validation
    - Module-level logger

    Specific implementation:
    1. Define _parse_bool(value: str, var_name: str) -> bool helper
       - Accepts: "1", "true", "yes" (case-insensitive) -> True
       - Accepts: "0", "false", "no", "" -> False
       - Rejects everything else with ValueError including var_name in message
    2. @dataclass EnvConfig with 4 fields: disable_packing, disable_fp16, v1_attention, viral_checkpoint_mode
       - Do NOT include CUDA_VISIBLE_DEVICES, PYTORCH_CUDA_ALLOC_CONF, TOKENIZERS_PARALLELISM (external tool vars)
       - Do NOT include VIRNUCPRO_DISABLE_COMPILE (does not exist in codebase yet)
    3. __post_init__ loads from os.environ.get() and parses via _parse_bool
    4. @lru_cache(maxsize=1) on get_env_config() factory function
    5. Module docstring with architecture notes:
       - Explains centralization purpose
       - Documents that env vars must be set BEFORE first get_env_config() call
       - Documents cache_clear() pattern for late-setting scenarios (e.g., CLI layer):
         ```
         os.environ['VIRNUCPRO_V1_ATTENTION'] = 'true'
         get_env_config.cache_clear()  # Invalidate cached instance
         env = get_env_config()        # New instance picks up the change
         ```
    6. get_env_config() docstring mentions cache_clear() for test isolation and late-setting
  </implementation>
</feature>

<verification>
pytest tests/unit/test_env_config.py -v
</verification>

<success_criteria>
- EnvConfig loads all 4 VIRNUCPRO_* environment variables (no external tool vars)
- Boolean parsing handles all valid values and rejects invalid ones with ValueError
- get_env_config() caching works correctly
- cache_clear() pattern is documented in module docstring and get_env_config() docstring
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/11-code-quality-foundations/11-01-SUMMARY.md`
</output>
