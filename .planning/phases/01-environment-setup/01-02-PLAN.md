---
phase: 01-environment-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - scripts/validate_environment.py
  - README.md
autonomous: false

must_haves:
  truths:
    - "Validation script checks all 5 ENV requirements and reports PASS/FAIL for each"
    - "SDPA benchmark demonstrates measurable speedup with actual timing numbers"
    - "FastESM2_650 model loads successfully from HuggingFace Hub"
    - "README documents the complete setup process with troubleshooting guidance"
  artifacts:
    - path: "scripts/validate_environment.py"
      provides: "Automated environment validation covering ENV-01 through ENV-05"
      min_lines: 80
    - path: "README.md"
      provides: "Setup instructions with troubleshooting section"
      contains: "pixi install"
  key_links:
    - from: "scripts/validate_environment.py"
      to: "Synthyra/FastESM2_650"
      via: "AutoModel.from_pretrained with trust_remote_code=True"
      pattern: "Synthyra/FastESM2_650"
    - from: "pixi.toml"
      to: "scripts/validate_environment.py"
      via: "pixi run validate task"
      pattern: 'validate = "python scripts/validate_environment.py"'
---

<objective>
Create the automated validation script that verifies all environment requirements (ENV-01 through ENV-05) including an actual SDPA speedup benchmark, and update the README with setup instructions and troubleshooting.

Purpose: Provide a single-command validation (`pixi run validate`) that proves the environment is correctly configured for FastESM2 migration. This is the gatekeeper for Phase 2 -- if validation fails, the environment is not ready.
Output: Validation script at scripts/validate_environment.py; updated README.md with setup process and troubleshooting.
</objective>

<execution_context>
@/home/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-environment-setup/01-RESEARCH.md
@.planning/phases/01-environment-setup/01-CONTEXT.md
@.planning/phases/01-environment-setup/01-01-SUMMARY.md
@pixi.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create automated environment validation script</name>
  <files>scripts/validate_environment.py</files>
  <action>
Create `scripts/validate_environment.py` -- the single validation script that checks all ENV requirements. The script must fail loudly (sys.exit(1)) on the first failure per user decision.

Create the `scripts/` directory first if it doesn't exist.

The script must check these requirements in order:

**ENV-01: PyTorch 2.5+ with CUDA**
- Verify `torch.__version__` parses to >= 2.5.0
- Verify `torch.cuda.is_available()` returns True
- Print CUDA device name and driver version for debugging

**ENV-02: fair-esm removed**
- Attempt `import esm` -- must raise ImportError
- If it imports successfully, FAIL with message explaining fair-esm must be removed

**ENV-03: transformers >= 4.30.0**
- Verify `transformers.__version__` parses to >= 4.30.0
- Print actual version

**ENV-04: FastESM2_650 model loads from HuggingFace Hub**
- Load model: `AutoModel.from_pretrained("Synthyra/FastESM2_650", trust_remote_code=True, torch_dtype=torch.float16)`
- Verify model is not None
- Verify model has `tokenizer` attribute (class attribute on FastEsmPreTrainedModel)
- Test tokenizer: tokenize a short protein sequence "MPRTEIN" and verify output has `input_ids` key
- Print model parameter count for verification (~651M)
- Note: This will download ~2.5GB on first run. Print a message before download starts.

**ENV-05: SDPA benchmark**
- Move model to GPU and set to eval mode
- Create test input: a protein sequence of 501 residues ("M" + "A" * 500) to maximize SDPA benefit
- Tokenize and move to GPU
- Warmup: 5 forward passes with default settings (SDPA path)
- Benchmark SDPA path: 50 forward passes with `output_attentions=False` (default), time with `torch.cuda.synchronize()` and `time.perf_counter()`
- Benchmark manual attention path: 50 forward passes with `output_attentions=True`, same timing
- Calculate speedup ratio: manual_time / sdpa_time
- Print: SDPA time, manual attention time, speedup ratio
- PASS if speedup >= 1.3x (research notes GB10 may not hit 2x; require at least 1.3x as meaningful speedup threshold)
- If speedup < 2.0x but >= 1.3x: print warning noting actual speedup vs claimed 2x, but still PASS
- If speedup < 1.3x: FAIL with message

**Script structure:**
- Use a `check(name, condition, message)` helper function that prints PASS/FAIL and exits on failure
- Print a header: "VirNucPro FastESM2 Environment Validation"
- Print section headers for each ENV requirement
- At the end, print "ALL CHECKS PASSED" with a summary of key versions and SDPA speedup
- Use `if __name__ == "__main__":` guard

**Error handling:**
- Wrap model download in try/except to catch network errors with clear message
- If CUDA is not available, fail immediately before attempting GPU operations
  </action>
  <verify>
Run `pixi run validate` (which executes `python scripts/validate_environment.py`). The script should:
1. Print PASS for each of ENV-01 through ENV-05
2. Show actual SDPA speedup ratio
3. Print "ALL CHECKS PASSED" at the end
4. Exit with code 0

If the model has not been downloaded yet, the first run will take longer (downloading ~2.5GB).
  </verify>
  <done>Validation script exists at scripts/validate_environment.py. Running `pixi run validate` checks all 5 ENV requirements, demonstrates actual SDPA speedup with timing numbers, and exits 0 on success or 1 on first failure.</done>
</task>

<task type="auto">
  <name>Task 2: Update README with setup instructions and troubleshooting</name>
  <files>README.md</files>
  <action>
Update README.md to document the FastESM2 migration environment setup. Per user decision, include step-by-step instructions and a troubleshooting section.

Read the existing README.md first to understand current content and preserve any useful sections.

The README should include:

**Section: FastESM2 Migration Setup**

Step-by-step setup process:
1. Prerequisites: NVIDIA GPU with CUDA driver 12.x+ (verify with `nvidia-smi`)
2. Install pixi if not already installed
3. Clone repository and enter directory
4. Run `pixi install` to set up the environment (installs PyTorch 2.5.1 with CUDA, transformers 4.45.2, and all dependencies)
5. Run `pixi run validate` to verify the environment (downloads FastESM2_650 model on first run, ~2.5GB)
6. All 5 checks should pass

**Section: Troubleshooting**

Common issues and solutions:
- `pixi install` fails with platform error: Check that you're on linux-aarch64. pixi.toml is configured for this platform only.
- CUDA not available (`torch.cuda.is_available()` returns False): Verify NVIDIA driver is installed (`nvidia-smi`). The CUDA toolkit is provided by conda-forge, but a driver must be installed at the system level.
- Model download fails: Check internet connection. The FastESM2_650 model (~2.5GB) is downloaded from HuggingFace Hub on first run. It's cached at `~/.cache/huggingface/hub/` after first download.
- SDPA speedup below threshold: SDPA performance varies by GPU architecture and sequence length. The benchmark uses 500+ residue sequences for maximum benefit.
- `ModuleNotFoundError: No module named 'esm'`: This is expected -- fair-esm has been intentionally removed. The old `extract_esm()` function has been replaced.

Keep existing README content that's still relevant (project description, usage for prediction pipeline, etc.) but update references to reflect the migration.

Do NOT remove existing usage documentation for prediction.py or other pipeline scripts -- those still work (except ESM2 extraction which is being migrated).
  </action>
  <verify>
- README.md exists and contains "pixi install" in setup instructions
- README.md contains "Troubleshooting" section
- README.md contains "pixi run validate" instruction
- README.md mentions FastESM2_650 migration context
  </verify>
  <done>README.md updated with FastESM2 migration setup instructions, step-by-step guide, and troubleshooting section covering common issues (CUDA, platform, model download, SDPA performance).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Environment validation script and updated README. The validation script checks all Phase 1 success criteria: PyTorch 2.5+ with CUDA, fair-esm removed, transformers 4.30+, FastESM2_650 model loads, and SDPA speedup benchmark.
  </what-built>
  <how-to-verify>
1. Run `pixi run validate` and confirm all 5 checks pass
2. Review the SDPA speedup number -- is the actual speedup acceptable on your hardware?
3. Skim README.md setup instructions -- do they make sense for your workflow?

Key things to check:
- The SDPA speedup ratio printed by the validation script. If it's >= 1.3x but < 2.0x, the script will PASS with a warning. Let me know if you want a different threshold.
- The FastESM2_650 model should load without errors. First run downloads ~2.5GB.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the validation results or documentation</resume-signal>
</task>

</tasks>

<verification>
1. `scripts/validate_environment.py` exists and is executable via `pixi run validate`
2. All 5 ENV checks pass: PyTorch 2.5+ CUDA, fair-esm removed, transformers 4.30+, FastESM2_650 loads, SDPA speedup
3. SDPA speedup ratio is printed with actual timing numbers
4. README.md documents setup process and troubleshooting
5. User has verified validation results on their hardware
</verification>

<success_criteria>
- `pixi run validate` exits 0 with all checks passing
- FastESM2_650 model loads and produces embeddings
- SDPA speedup is measurable (>= 1.3x) on target GPU
- README has setup instructions and troubleshooting section
- User approves validation results
</success_criteria>

<output>
After completion, create `.planning/phases/01-environment-setup/01-02-SUMMARY.md`
</output>
