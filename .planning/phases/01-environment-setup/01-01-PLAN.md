---
phase: 01-environment-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pixi.toml
  - units.py
  - features_extract.py
autonomous: true

must_haves:
  truths:
    - "pixi install completes successfully with PyTorch 2.5.1, CUDA support, and transformers 4.45.2"
    - "fair-esm is not present in the environment"
    - "units.py can be imported without ModuleNotFoundError for esm"
    - "features_extract.py no longer references pretrained.load_model_and_alphabet at module level"
  artifacts:
    - path: "pixi.toml"
      provides: "Complete dependency specification with exact version pins"
      contains: "pytorch = \"==2.5.1\""
    - path: "units.py"
      provides: "Shared utilities importable without fair-esm"
    - path: "features_extract.py"
      provides: "Feature extraction script without module-level ESM2 3B loading"
  key_links:
    - from: "pixi.toml"
      to: "pixi.lock"
      via: "pixi install resolves and locks all dependencies"
      pattern: "pytorch.*2\\.5\\.1"
    - from: "units.py"
      to: "features_extract.py"
      via: "from units import * must succeed"
      pattern: "from units import"
---

<objective>
Configure the pixi environment with all FastESM2-compatible dependencies and fix fair-esm imports so the codebase is importable.

Purpose: Establish the dependency foundation (PyTorch 2.5.1 + CUDA, transformers 4.45.2, einops, networkx) and remove the fair-esm package that would conflict with the new pipeline. Without this, no subsequent phase work can proceed.
Output: Working pixi environment with locked dependencies; importable Python modules with no fair-esm references.
</objective>

<execution_context>
@/home/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-environment-setup/01-RESEARCH.md
@.planning/phases/01-environment-setup/01-CONTEXT.md
@units.py
@features_extract.py
@pixi.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite pixi.toml with pinned FastESM2-compatible dependencies</name>
  <files>pixi.toml</files>
  <action>
Replace the current pixi.toml contents with the full dependency specification for FastESM2 migration. Use exact version pinning per user decision.

The pixi.toml must contain:

```toml
[workspace]
channels = ["conda-forge"]
name = "VirNucPro"
platforms = ["linux-aarch64"]
version = "0.1.0"

[dependencies]
python = "3.9.*"
pytorch = "==2.5.1"
pytorch-gpu = "==2.5.1"
transformers = "==4.45.2"
einops = "==0.8.2"
networkx = ">=3.2"
biopython = ">=1.80"
numpy = ">=1.19,<2"
tqdm = ">=4.27"
scikit-learn = ">=1.0"
safetensors = ">=0.4.1"
scipy = ">=1.7"
matplotlib = ">=3.5"
pandas = ">=1.3"

[tasks]
validate = "python scripts/validate_environment.py"
```

Key decisions reflected:
- `pytorch-gpu` meta-package ensures CUDA-enabled build (CUDA 12.6 from conda-forge, forward-compatible with CUDA 13.0 driver)
- `transformers = "==4.45.2"` matches the version FastESM2_650 was developed against (4.45.0), latest patch
- `einops` and `networkx` are required by FastESM2_650 modeling code
- `safetensors` is required by transformers for loading model weights
- `pandas` added (used by prediction.py, was missing from old pixi.toml)
- No `pip` dependency -- all packages from conda-forge
- No `fair-esm` -- removed per user decision

After writing pixi.toml, run `pixi install` to resolve and lock all dependencies. This will regenerate pixi.lock.

Important: Do NOT include `pip` in dependencies. The old pixi.toml had pip for installing packages via requirements.txt, but the new approach uses conda-forge exclusively per user decision (fresh environment from scratch).
  </action>
  <verify>
Run `pixi install` and confirm it exits successfully (exit code 0). Then verify key packages:
- `pixi run python -c "import torch; print(torch.__version__)"` shows 2.5.1
- `pixi run python -c "import torch; print(torch.cuda.is_available())"` shows True
- `pixi run python -c "import transformers; print(transformers.__version__)"` shows 4.45.2
- `pixi run python -c "import einops; print('einops OK')"` succeeds
- `pixi run python -c "import esm"` fails with ImportError (fair-esm not installed)
  </verify>
  <done>pixi.lock regenerated with all dependencies resolved. PyTorch 2.5.1 with CUDA, transformers 4.45.2, einops, networkx, and all supporting packages installed. fair-esm is NOT in the environment.</done>
</task>

<task type="auto">
  <name>Task 2: Remove fair-esm imports and guard deprecated ESM2 3B code</name>
  <files>units.py, features_extract.py</files>
  <action>
Fix all fair-esm references so the codebase is importable in the new environment.

**units.py changes:**

1. Remove line 7: `from esm import FastaBatchedDataset, pretrained`
2. Add a comment explaining the removal: `# fair-esm removed - extract_esm() deprecated, replaced by extract_fast_esm() in Phase 2`
3. Modify the `extract_esm()` function body to raise `NotImplementedError` immediately, preserving the function signature for reference:
   - Keep the function signature exactly as-is (serves as documentation of the old API)
   - Replace the entire function body with:
     ```python
     raise NotImplementedError(
         "extract_esm() requires fair-esm which has been removed. "
         "Use extract_fast_esm() instead (implemented in Phase 2)."
     )
     ```

**features_extract.py changes:**

1. Remove line 12: `ESM_model, ESM_alphabet = pretrained.load_model_and_alphabet('esm2_t36_3B_UR50D')`
   - This line executes at module import time and would crash immediately
   - Replace with a comment: `# ESM2 3B model loading removed - will be replaced with FastESM2_650 in Phase 2`
2. The `process_file_pro()` function calls `extract_esm()` which now raises NotImplementedError
   - This is acceptable for Phase 1 -- the function won't be called until Phase 2 rewrites it
   - Do NOT rewrite process_file_pro() -- that's Phase 2 scope

**Do NOT modify:**
- prediction.py -- it imports `extract_esm` via `from units import *` but that's fine since extract_esm() still exists (just raises NotImplementedError when called)
- Any other files -- the grep shows fair-esm import only exists in units.py line 7
  </action>
  <verify>
Run these commands to verify imports work:
- `pixi run python -c "from units import split_fasta_chunk, extract_DNABERT_S, merge_data; print('units.py imports OK')"` -- succeeds
- `pixi run python -c "from units import extract_esm; print('extract_esm exists')"` -- succeeds (function exists)
- `pixi run python -c "from units import extract_esm; extract_esm('test.fa')"` -- fails with NotImplementedError (expected)
- `pixi run python -c "import units; print('units module OK')"` -- succeeds with no ModuleNotFoundError
  </verify>
  <done>units.py imports without errors. extract_esm() exists but raises NotImplementedError with clear message. features_extract.py no longer attempts to load ESM2 3B model at import time. All other functions in units.py (extract_DNABERT_S, merge_data, split_fasta_file, etc.) remain unchanged and functional.</done>
</task>

</tasks>

<verification>
1. `pixi install` completed successfully
2. `pixi run python -c "import torch; print(torch.__version__, torch.cuda.is_available())"` shows "2.5.1 True"
3. `pixi run python -c "import transformers; print(transformers.__version__)"` shows "4.45.2"
4. `pixi run python -c "import units"` succeeds without errors
5. `pixi run python -c "import esm"` fails with ImportError (fair-esm not present)
6. `pixi run python -c "from units import extract_esm; extract_esm('x')"` raises NotImplementedError
</verification>

<success_criteria>
- pixi environment installs cleanly with all dependencies resolved
- PyTorch 2.5.1 with CUDA support is available
- transformers 4.45.2 is installed
- fair-esm is NOT in the environment
- units.py can be imported without errors
- features_extract.py does not crash at import time
</success_criteria>

<output>
After completion, create `.planning/phases/01-environment-setup/01-01-SUMMARY.md`
</output>
