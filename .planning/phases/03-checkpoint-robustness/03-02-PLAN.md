---
phase: 03-checkpoint-robustness
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [virnucpro/core/checkpoint.py, virnucpro/core/checkpoint_validation.py, virnucpro/cli.py]
autonomous: true

must_haves:
  truths:
    - "Checkpoints have version metadata embedded"
    - "Pre-optimization checkpoints load without modification"
    - "Failed checkpoints are tracked in log file"
  artifacts:
    - path: "virnucpro/core/checkpoint.py"
      provides: "Version management and backward compatibility"
      contains: "CHECKPOINT_VERSION"
    - path: "failed_checkpoints.txt"
      provides: "Failed checkpoint tracking log"
      format: "{path}|{reason}|{timestamp}"
  key_links:
    - from: "virnucpro/core/checkpoint.py"
      to: "version metadata"
      via: "embedding in checkpoint dict"
      pattern: "'version'.*CHECKPOINT_VERSION"
---

<objective>
Add version management to checkpoints and support backward compatibility with pre-optimization checkpoints.

Purpose: Enable safe evolution of checkpoint format while maintaining ability to resume from older runs.
Output: Versioned checkpoint system with backward compatibility and failed checkpoint tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-checkpoint-robustness/03-CONTEXT.md
@.planning/phases/03-checkpoint-robustness/03-RESEARCH.md
@.planning/phases/03-checkpoint-robustness/03-01-SUMMARY.md

# Core checkpoint modules
@virnucpro/core/checkpoint.py
@virnucpro/core/checkpoint_validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version management to checkpoints</name>
  <files>virnucpro/core/checkpoint.py</files>
  <action>
    Add version metadata support to checkpoint system:

    1. Define CHECKPOINT_VERSION = "1.0" constant at module level
    2. Update atomic_save() to embed version metadata:
       - If dict passed, add 'version' and 'status' fields
       - 'version': CHECKPOINT_VERSION
       - 'status': 'complete' (set after successful save)

    3. Add load_with_compatibility() function:
       - Load checkpoint with torch.load
       - Check for 'version' field
       - If missing, treat as version "0.x" (pre-optimization)
       - If version > CHECKPOINT_VERSION, raise error with upgrade message
       - Return checkpoint dict with version info

    4. Update CheckpointManager.load_stage_status() and other load methods:
       - Use load_with_compatibility() instead of direct torch.load
       - Log version info when loading ("Loading checkpoint v{version}")
       - Handle version 0.x checkpoints (read-only, no modification)

    Follow decisions from CONTEXT.md: version 1.0 for optimized, 0.x for pre-optimization.
  </action>
  <verify>grep -n "CHECKPOINT_VERSION" virnucpro/core/checkpoint.py</verify>
  <done>checkpoint.py contains version management with CHECKPOINT_VERSION constant</done>
</task>

<task type="auto">
  <name>Task 2: Add failed checkpoint tracking</name>
  <files>virnucpro/core/checkpoint_validation.py</files>
  <action>
    Add failed checkpoint tracking utilities:

    1. Create log_failed_checkpoint() function:
       - Takes checkpoint_path, reason, and optional timestamp
       - Appends to failed_checkpoints.txt in checkpoint directory
       - Format: "{checkpoint_path}|{reason}|{timestamp}"
       - Creates file if it doesn't exist

    2. Update validate_checkpoint() to optionally log failures:
       - Add log_failures parameter (default False)
       - If validation fails and log_failures=True, call log_failed_checkpoint()

    3. Add load_failed_checkpoints() function:
       - Reads failed_checkpoints.txt if exists
       - Returns list of (path, reason, timestamp) tuples
       - Used for resume logging summary

    4. Create checkpoint exit code constant:
       - CHECKPOINT_EXIT_CODE = 3
       - Document: 0=success, 1=generic, 2=partial pipeline, 3=checkpoint issue

    Match the failed_files.txt pattern from Phase 1 for consistency.
  </action>
  <verify>grep -n "log_failed_checkpoint" virnucpro/core/checkpoint_validation.py</verify>
  <done>checkpoint_validation.py contains failed checkpoint tracking functions</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI flags for checkpoint control</name>
  <files>virnucpro/cli.py</files>
  <action>
    Add CLI flags for checkpoint validation and recovery control:

    1. Add --skip-checkpoint-validation flag:
       - Boolean flag, default False
       - Help: "Skip checkpoint validation for trusted scenarios (faster but risky)"
       - Pass to pipeline config

    2. Add --force-resume flag:
       - Boolean flag, default False
       - Help: "Force resume even if some checkpoints are corrupted"
       - Pass to pipeline config

    3. Add validate-checkpoints subcommand:
       - Takes checkpoint_dir as argument
       - Calls validation utilities to check all checkpoints
       - Reports status without processing
       - Returns appropriate exit code

    4. Update predict command to pass new flags to CheckpointManager:
       - skip_validation = args.skip_checkpoint_validation
       - force_resume = args.force_resume

    These flags enable the recovery behaviors specified in CONTEXT.md.
  </action>
  <verify>python -m virnucpro.cli --help | grep -E "(skip-checkpoint|force-resume|validate)"</verify>
  <done>CLI has checkpoint control flags and validate-checkpoints command</done>
</task>

</tasks>

<verification>
1. Checkpoints contain version metadata (version field)
2. Pre-optimization checkpoints (no version) load as version 0.x
3. Failed checkpoints are logged to failed_checkpoints.txt
4. CLI flags control validation and recovery behavior
</verification>

<success_criteria>
- CHECKPOINT_VERSION constant defined as "1.0"
- load_with_compatibility handles version checking
- failed_checkpoints.txt tracks validation failures
- CLI has --skip-checkpoint-validation and --force-resume flags
- validate-checkpoints command available
</success_criteria>

<output>
After completion, create `.planning/phases/03-checkpoint-robustness/03-02-SUMMARY.md`
</output>