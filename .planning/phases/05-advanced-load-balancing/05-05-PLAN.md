---
phase: 05-advanced-load-balancing
plan: 05
type: execute
wave: 4
depends_on: ["05-01", "05-02", "05-03", "05-04"]
files_modified:
  - tests/test_load_balancing.py
  - tests/test_gpu_weights.py
  - tests/test_work_stealing.py
autonomous: true

must_haves:
  truths:
    - "Tests verify work stealing functionality"
    - "Tests confirm GPU weights properly applied"
    - "Tests validate load distribution fairness"
  artifacts:
    - path: "tests/test_load_balancing.py"
      provides: "Load balancing integration tests"
      min_lines: 200
    - path: "tests/test_gpu_weights.py"
      provides: "GPU weight assignment tests"
      min_lines: 100
    - path: "tests/test_work_stealing.py"
      provides: "Work stealing unit tests"
      min_lines: 150
  key_links:
    - from: "test_load_balancing.py"
      to: "load_balancer.py"
      via: "tests WorkStealingCoordinator"
      pattern: "WorkStealingCoordinator"
    - from: "test_gpu_weights.py"
      to: "gpu_weights.py"
      via: "tests weight functions"
      pattern: "get_gpu_weight|assign_files_weighted"
---

<objective>
Create comprehensive test suite for work stealing, GPU weighting, and load distribution fairness.

Purpose: Ensure load balancing features work correctly and improve GPU utilization.
Output: Test files covering all load balancing functionality with high coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-advanced-load-balancing/05-CONTEXT.md

@tests/test_parallel_processing.py
@tests/test_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create work stealing unit tests</name>
  <files>tests/test_work_stealing.py</files>
  <action>
    Create comprehensive unit tests for WorkStealingCoordinator functionality.

    Test cases:
    1. test_create_shared_queues() - verify Manager.Queue creation and cross-process access
    2. test_queue_population() - ensure initial file assignment populates queues correctly
    3. test_try_steal_work() - test stealing logic with various queue states
    4. test_steal_threshold() - verify stealing only triggers on significant imbalance
    5. test_victim_selection() - test round-robin or random victim selection
    6. test_empty_queue_handling() - ensure Empty exception handled properly
    7. test_manager_lifetime() - verify Manager stays alive for queue lifetime
    8. test_concurrent_stealing() - multiple workers stealing simultaneously (no deadlocks)
    9. test_metrics_collection() - verify metrics tracking (steals, throughput, etc.)
    10. test_no_stealing_when_balanced() - ensure no unnecessary stealing

    Use unittest.mock to:
    - Mock multiprocessing.Manager for controlled testing
    - Mock torch.cuda functions for GPU info
    - Control queue states for deterministic tests

    Critical tests:
    - Never use qsize() or empty() for control flow
    - Always use try-except with Empty
    - Manager object lifetime properly managed
  </action>
  <verify>grep -n "class.*Test.*WorkStealing" tests/test_work_stealing.py && grep -n "test_try_steal_work" tests/test_work_stealing.py</verify>
  <done>Work stealing unit tests cover coordinator functionality and edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Create GPU weight tests</name>
  <files>tests/test_gpu_weights.py</files>
  <action>
    Create tests for GPU capability weighting and weighted file assignment.

    Test cases:
    1. test_gpu_weight_lookup() - verify correct weights for known GPU models
    2. test_unknown_gpu_default() - ensure unknown GPUs get weight 1.0
    3. test_weighted_assignment_proportional() - verify files distributed proportional to weights
    4. test_heterogeneous_gpus() - test 3090 + 4090 mix gets proper distribution
    5. test_weight_normalization() - ensure total work roughly equal after weighting
    6. test_single_gpu_fallback() - single GPU gets all files regardless of weight
    7. test_weight_logging() - verify assignment logs show GPU models and weights

    Mock torch.cuda.get_device_name() to return specific GPU models for testing.
    Test with various file counts and sequence distributions.

    Verify weighted assignment gives faster GPUs more work:
    - 4090 (weight 1.5) should get ~1.5x files of 3090 (weight 1.0)
    - H100 (weight 2.5) should get ~2.5x files of 3090
  </action>
  <verify>grep -n "test_weighted_assignment" tests/test_gpu_weights.py && grep -n "test_heterogeneous_gpus" tests/test_gpu_weights.py</verify>
  <done>GPU weight tests verify capability-based file distribution</done>
</task>

<task type="auto">
  <name>Task 3: Create load balancing integration tests</name>
  <files>tests/test_load_balancing.py</files>
  <action>
    Create integration tests for end-to-end load balancing with work stealing and GPU weighting.

    Test scenarios:
    1. test_idle_gpu_steals_work() - simulate imbalanced load, verify stealing happens
    2. test_work_distribution_fairness() - measure coefficient of variation in completion times
    3. test_dashboard_metrics_accuracy() - verify dashboard shows correct GPU stats
    4. test_cli_flags_control() - ensure --work-stealing and --gpu-weighted flags work
    5. test_backward_compatibility() - verify features disabled by default
    6. test_mixed_gpu_scenario() - heterogeneous GPUs with work stealing
    7. test_throughput_improvement() - measure speedup with load balancing enabled
    8. test_no_deadlocks() - stress test with many GPUs and frequent stealing
    9. test_graceful_shutdown() - coordinator and dashboard clean up properly
    10. test_steal_event_logging() - verify steal events tracked and displayed

    Use multiprocessing to create realistic multi-GPU scenarios.
    Create synthetic workloads with varying file sizes.
    Measure metrics like:
    - Load imbalance (max/min queue depth)
    - Total completion time
    - Work stealing frequency
    - GPU idle time

    Assert that work stealing reduces imbalance and improves throughput.
  </action>
  <verify>grep -n "test_idle_gpu_steals_work" tests/test_load_balancing.py && grep -n "test_work_distribution_fairness" tests/test_load_balancing.py</verify>
  <done>Integration tests validate complete load balancing system</done>
</task>

</tasks>

<verification>
- Work stealing unit tests cover all coordinator functionality
- GPU weight tests verify proportional file distribution
- Integration tests prove load balancing improves utilization
- Tests check for deadlocks and race conditions
- Backward compatibility validated
</verification>

<success_criteria>
- All test files created with comprehensive coverage
- Work stealing reduces load imbalance in tests
- GPU weighting properly distributes work
- No deadlocks or race conditions in stress tests
- Performance improvements measurable in integration tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-advanced-load-balancing/05-05-SUMMARY.md`
</output>