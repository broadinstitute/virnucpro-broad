---
phase: 10.1-cli-integration
plan: 01
subsystem: cli
tags: [click, multi-gpu, async-dataloader, hybrid-architecture, runtime-config]

# Dependency graph
requires:
  - phase: 09-checkpointing-integration
    provides: RuntimeConfig and checkpoint infrastructure for v2.0
  - phase: 07-multi-gpu-coordination
    provides: run_multi_gpu_inference API for v2.0 ESM-2 embedding
  - phase: 06-sequence-packing-integration
    provides: FlashAttention and sequence packing for v2.0
provides:
  - CLI routing to v2.0 async architecture for ESM-2 (--parallel flag)
  - --v1-fallback flag for backward compatibility
  - RuntimeConfig construction from CLI flags (--resume, --force-resume)
  - Hybrid architecture logging ("ESM-2 v2.0, DNABERT-S v1.0")
  - HDF5-to-PT format adapter for merge stage compatibility
affects: [10-benchmarking, 10.2-dnabert-v2-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Hybrid architecture: ESM-2 v2.0, DNABERT-S v1.0 (staged validation approach)"
    - "Streaming HDF5-to-PT conversion to avoid memory issues"
    - "Fail-fast on v2.0 worker failures (no synthetic format conversion)"

key-files:
  created:
    - tests/unit/test_cli_predict.py
  modified:
    - virnucpro/cli/predict.py
    - virnucpro/pipeline/prediction.py

key-decisions:
  - "Hybrid architecture: Only ESM-2 uses v2.0, DNABERT-S stays v1.0 (DNABERT-S not validated in Phases 5-9)"
  - "Streaming HDF5-to-PT adapter with 10K chunk size avoids loading entire HDF5 into memory"
  - "Fail-fast if any v2.0 ESM-2 worker fails instead of trying to map ranks to files"
  - "RuntimeConfig constructed from CLI flags when v2.0 active (--resume, --force-resume)"

patterns-established:
  - "Architecture version determined by: use_v2 = parallel and not v1_fallback"
  - "Log architecture version explicitly: 'v2.0 hybrid' vs 'v1.0 fallback'"
  - "Pass explicit world_size to run_multi_gpu_inference matching detected GPUs"

# Metrics
duration: 4min
completed: 2026-02-06
---

# Phase 10.1 Plan 01: CLI Integration for v2.0 Architecture Summary

**CLI routes --parallel ESM-2 to v2.0 async architecture with explicit world_size, DNABERT-S stays v1.0, --v1-fallback preserves full v1.0 behavior**

## Performance

- **Duration:** 4 min
- **Started:** 2026-02-06T19:35:02Z
- **Completed:** 2026-02-06T19:39:56Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments
- CLI predict command routes `--parallel` ESM-2 to v2.0 async architecture by default
- Added `--v1-fallback` flag for backward compatibility (routes all to v1.0)
- DNABERT-S stays on v1.0 (Stage 5 untouched) - only ESM-2 uses v2.0
- RuntimeConfig constructed from CLI flags (--resume, --force-resume) and passed to v2.0 API
- HDF5-to-PT streaming adapter converts v2.0 output for merge stage compatibility
- 7 CLI integration tests verify routing logic without GPU dependencies

## Task Commits

Each task was committed atomically:

1. **Task 1: Update predict.py and prediction.py for hybrid v2.0 routing (ESM-2 only)** - `d7f8d0e` (feat)
2. **Task 2: CLI integration tests for v2.0 routing** - `1a42133` (test)

## Files Created/Modified
- `virnucpro/cli/predict.py` - Added --v1-fallback flag, architecture detection (use_v2 = parallel and not v1_fallback), RuntimeConfig construction, logging of hybrid architecture
- `virnucpro/pipeline/prediction.py` - Added use_v2_architecture and runtime_config parameters, v2.0 branch in Stage 6 (ESM-2) calling run_multi_gpu_inference with explicit world_size, _stream_h5_to_pt_files() helper for HDF5-to-PT conversion
- `tests/unit/test_cli_predict.py` - 7 CLI integration tests verifying v2.0 routing, v1.0 fallback, RuntimeConfig construction, architecture logging (all CPU-only with mocking)

## Decisions Made

1. **Hybrid architecture approach**: Only ESM-2 uses v2.0 async architecture. DNABERT-S stays on v1.0 because:
   - Phases 5-9 only validated ESM-2 protein sequences through v2.0
   - DNABERT-S requires different tokenizer (DNA k-mers), different max_length (512)
   - DNABERT-S is already fast (1M sequences in 3-4 min) - ESM-2 is the bottleneck
   - DNABERT-S v2.0 support planned for Phase 10.2 or v2.1 milestone

2. **Streaming HDF5-to-PT adapter**: Use chunked reads (10K sequences per chunk) to avoid loading entire HDF5 into memory. Alternative of updating merge stage to read HDF5 directly would be cleaner but is larger refactor touching Stages 7-9. Adapter approach maintains compatibility with zero downstream changes. Merge stage refactor can happen in Phase 10.2.

3. **Fail-fast on worker failures**: If any v2.0 ESM-2 worker fails, raise RuntimeError immediately. Do not attempt to map ranks back to individual files (requires index lookup). This is simpler than partial failure handling at CLI level and aligns with critical blocker purpose (all-or-nothing for Phase 10 benchmarks).

4. **RuntimeConfig construction**: When v2.0 is active (parallel and not v1_fallback), construct RuntimeConfig from CLI flags:
   - enable_checkpointing = resume or force_resume
   - checkpoint_dir = output_dir / '.checkpoints'
   - force_restart = force_resume

5. **Explicit world_size**: Pass world_size=num_gpus explicitly to run_multi_gpu_inference instead of relying on auto-detection. This matches CLI GPU selection and makes the routing explicit.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed as planned.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Phase 10 benchmarks:**
- `python -m virnucpro predict --parallel` now routes ESM-2 to v2.0 async architecture
- Phase 10 Plan 05 (v1.0 vs v2.0 comparison) will correctly compare architectures
- --v1-fallback preserves full v1.0 behavior for baseline measurements

**Blockers removed:**
- CLI integration was critical blocker for Phase 10
- Without this change, --parallel would route to v1.0 workers, making benchmarks meaningless

**Notes:**
- DNABERT-S v2.0 integration planned for Phase 10.2 or v2.1
- Merge stage HDF5 refactor (cleaner than adapter) can happen in Phase 10.2

---
*Phase: 10.1-cli-integration*
*Completed: 2026-02-06*
