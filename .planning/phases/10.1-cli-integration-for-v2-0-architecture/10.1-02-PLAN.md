---
phase: 10.1-cli-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - virnucpro/cli/benchmark.py
  - docs/MIGRATION_v2.md
autonomous: true

must_haves:
  truths:
    - "virnucpro benchmark --suite v2-validation runs Phase 10 test classes"
    - "virnucpro benchmark --suite v1-comparison runs v1 vs v2 comparison"
    - "Migration guide documents hybrid approach: ESM-2 uses v2.0, DNABERT-S stays v1.0"
    - "Migration guide documents --v1-fallback flag usage"
    - "Migration guide documents deprecated CLI options (--esm-batch-size, --dnabert-batch-size)"
    - "Migration guide explains why DNABERT-S stays v1.0 and notes v2.1 future work"
  artifacts:
    - path: "virnucpro/cli/benchmark.py"
      provides: "Updated benchmark CLI with Phase 10 test suites"
      contains: "v2-validation"
    - path: "docs/MIGRATION_v2.md"
      provides: "v1.0 to v2.0 migration guide with hybrid architecture documentation"
      min_lines: 60
  key_links:
    - from: "virnucpro/cli/benchmark.py"
      to: "tests/benchmarks/"
      via: "pytest subprocess invocation with markers"
      pattern: "pytest.*tests/benchmarks"
---

<objective>
Update benchmark CLI to expose Phase 10 validation tests and create a migration guide documenting v1.0 to v2.0 breaking changes with accurate hybrid architecture description.

Purpose: CLI-02 requires benchmark CLI exposure for Phase 10 tests so users can run `virnucpro benchmark --suite v2-validation` without knowing pytest commands. The migration guide documents the hybrid approach (ESM-2 v2.0, DNABERT-S v1.0), all breaking changes, and future roadmap for DNABERT-S v2.0 support. These are independent of the predict.py routing changes in Plan 01.

Output: Updated `virnucpro/cli/benchmark.py`, new `docs/MIGRATION_v2.md`
</objective>

<execution_context>
@/home/unix/carze/.claude/get-shit-done/workflows/execute-plan.md
@/home/unix/carze/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10.1-cli-integration-for-v2-0-architecture/10.1-RESEARCH.md
@virnucpro/cli/benchmark.py
@virnucpro/cli/main.py
@docs/GPU_OPTIMIZATION.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update benchmark CLI with Phase 10 test suites</name>
  <files>virnucpro/cli/benchmark.py</files>
  <action>
Update `virnucpro/cli/benchmark.py` to add v2.0 Phase 10 test suites:

1. **Expand the `--suite` option** (line 16) to include new choices:
   ```python
   type=click.Choice([
       'scaling', 'throughput', 'memory', 'equivalence',  # existing
       'v2-validation', 'v2-scaling', 'v2-throughput', 'v1-comparison',  # new Phase 10
       'all'
   ]),
   ```

2. **Update the docstring** (lines 47-93) to document new suites:
   Add under the "benchmark suite includes" section:
   ```
   - v2-validation: Production workload benchmark (PERF requirements)
   - v2-scaling: Multi-GPU scaling validation (2-GPU 1.9x)
   - v2-throughput: DataLoader and packing parameter sweep
   - v1-comparison: v1.0 vs v2.0 speedup comparison (conditional)
   ```

   Add new examples:
   ```
   # Run v2.0 production validation
   virnucpro benchmark --suite v2-validation

   # v1.0 vs v2.0 comparison (requires v1.0 git tag)
   virnucpro benchmark --suite v1-comparison --data-size medium
   ```

3. **Update `_build_pytest_command()`** to handle new suites (around line 241):
   Add new elif branches:
   ```python
   elif suite == 'v2-validation':
       cmd.extend(['-k', 'TestProductionValidation'])
   elif suite == 'v2-scaling':
       cmd.extend(['-k', 'TestV2Scaling'])
   elif suite == 'v2-throughput':
       cmd.extend(['-k', 'TestParameterTuning'])
   elif suite == 'v1-comparison':
       cmd.extend(['-k', 'TestV1Comparison'])
   ```
   These use `-k` (keyword expression) instead of `-m` (marker) because the Phase 10 tests are organized by class name, not separate markers. The `-k` filter selects test classes matching the keyword.

4. **Add v1-comparison specific handling** in the main `benchmark()` function: After the `if quick:` block, add:
   ```python
   # v1-comparison needs special handling
   if suite == 'v1-comparison':
       logger.info("Note: v1.0 comparison requires 'v1.0' git tag in repository")
       logger.info("Tests will skip gracefully if v1.0 tag is unavailable")
   ```

5. **Update the `_display_summary()` function** to handle Phase 10 report format. The Phase 10 tests may produce reports with different keys. Add a fallback for missing keys:
   ```python
   # Handle both v1.0 benchmark format and Phase 10 format
   speedups = report.get('performance', {}).get('speedups', {})
   # ... existing code with safe .get() calls
   ```
   The existing code already uses `.get()` with defaults, so minimal changes needed here. Just ensure no KeyError on new report formats.

Do NOT change the existing suite behaviors ('scaling', 'throughput', 'memory', 'equivalence', 'all'). Those are v1.0 benchmarks and must continue working.
  </action>
  <verify>
    python -m virnucpro benchmark --help 2>&1 | grep -E "v2-validation|v1-comparison|v2-scaling|v2-throughput"
  </verify>
  <done>
    `virnucpro benchmark --suite v2-validation` runs Phase 10 production workload tests. `--suite v2-scaling` runs multi-GPU scaling. `--suite v2-throughput` runs parameter sweep. `--suite v1-comparison` runs v1.0 vs v2.0 comparison with graceful skip message. Existing suites unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create v1.0 to v2.0 migration guide with hybrid architecture</name>
  <files>docs/MIGRATION_v2.md</files>
  <action>
Create `docs/MIGRATION_v2.md` documenting all breaking changes, the hybrid approach, and migration paths.

**IMPORTANT (Issue 5):** The architecture table must accurately reflect the HYBRID approach where ESM-2 uses v2.0 and DNABERT-S stays v1.0. Do NOT claim both models use v2.0.

```markdown
# Migration Guide: v1.0 to v2.0

## Overview

VirNucPro v2.0 replaces the multi-worker-per-GPU architecture with a single-process-per-GPU
async DataLoader pattern for ESM-2 protein embedding. This delivers 4-5x throughput improvement
through sequence packing, FlashAttention varlen, and FP16 precision.

**v2.0 is the default when using `--parallel`.** v1.0 behavior is available via `--v1-fallback`.

## Hybrid Architecture (v2.0)

v2.0 uses a **hybrid approach** where only ESM-2 embedding uses the new architecture:

| Pipeline Stage | v1.0 | v2.0 (current) | Future (v2.1) |
|----------------|------|----------------|---------------|
| Chunking | Sequential | Sequential (unchanged) | - |
| Translation | Parallel CPU | Parallel CPU (unchanged) | - |
| File Splitting | Sequential | Sequential (unchanged) | - |
| DNABERT-S embedding | Multi-worker-per-GPU | **v1.0 (unchanged)** | v2.0 planned |
| ESM-2 embedding | Multi-worker-per-GPU | **v2.0 async DataLoader** | - |
| Feature Merging | Parallel CPU | Parallel CPU (unchanged) | - |
| Prediction | Sequential | Sequential (unchanged) | - |
| Consensus | Sequential | Sequential (unchanged) | - |

### Why DNABERT-S Stays v1.0

1. **Performance:** DNABERT-S processes 1M sequences in 3-4 minutes. ESM-2 (3B params) is the
   bottleneck at 45+ hours. Optimizing DNABERT-S provides minimal overall speedup.
2. **Validation:** Phases 5-9 only validated ESM-2 protein sequences through v2.0. DNABERT-S
   requires different tokenizer (DNA k-mers), different max_length (512), and different input
   format (nucleotide chunks vs protein sequences).
3. **Risk:** Running untested DNABERT-S through v2.0 could produce garbage embeddings.

DNABERT-S v2.0 support is planned for Phase 10.2 or the v2.1 milestone.

## What Changed

### Architecture (ESM-2 Only)

| Aspect | v1.0 | v2.0 |
|--------|------|------|
| GPU process model | N workers per GPU (multiprocessing.Pool) | 1 process per GPU (async DataLoader) |
| Memory per GPU | N x 11GB (model copies) | 1 x 6GB (single model, FP16) |
| Batching | Fixed batch size, padded | Dynamic token budget, packed sequences |
| Precision | BF16 (Ampere+) / FP32 | FP16 with FlashAttention |
| Attention | Standard / PyTorch SDPA | FlashAttention-2 varlen (packed) |
| Checkpointing | Per-file .pt with .done markers | Per-shard HDF5 with manifest |
| Output format | Per-file .pt tensors | Merged embeddings.h5 (adapter converts to .pt for pipeline) |

### CLI Changes

**No breaking changes to command-line interface.**

The `--parallel` flag now routes ESM-2 to v2.0 architecture by default. All existing flags
continue to work. New flags added:

| Flag | Purpose |
|------|---------|
| `--v1-fallback` | Force v1.0 multi-worker architecture for all stages (including ESM-2) |

### Deprecated Options

These options still work but have no effect in v2.0 mode (ESM-2 only):

| Option | v1.0 Behavior | v2.0 Behavior |
|--------|---------------|---------------|
| `--esm-batch-size` | Sets tokens per batch | Ignored (dynamic token budget from GPU memory) |
| `--dnabert-batch-size` | Sets tokens per batch | Still used (DNABERT-S is v1.0) |
| `--dataloader-workers` | Sets DataLoader worker count | Used by v2.0 DataLoader (default: auto-detect) |
| `--persistent-models` | Keep models loaded between stages | No effect on ESM-2 (single model per process) |

### New Capabilities (v2.0, ESM-2 only)

- **Sequence packing**: Multiple short sequences packed into single batches via FFD algorithm
- **FlashAttention varlen**: Packed attention without cross-sequence contamination
- **Incremental checkpointing**: Resume from sequence-level checkpoints (not file-level)
- **Spot instance support**: SIGTERM handler saves emergency checkpoint, automatic resume
- **Elastic redistribution**: Failed GPU work reassigned to healthy GPUs

## How to Migrate

### Basic Usage (No Changes Required)

```bash
# This just works -- v2.0 is the default for ESM-2 with --parallel
python -m virnucpro predict input.fasta --parallel
```

### If You Need Full v1.0 Behavior

```bash
# Explicitly request v1.0 architecture for all stages
python -m virnucpro predict input.fasta --parallel --v1-fallback
```

### Checking Which Architecture Is Active

Look for architecture log line in output:
```
Architecture: v2.0 hybrid
  ESM-2 embedding: v2.0 (async DataLoader + sequence packing)
  DNABERT-S embedding: v1.0 (fast enough, v2.0 planned for v2.1)
```
or:
```
Architecture: v1.0 (--v1-fallback, all stages use legacy multi-worker)
```

### Running Performance Benchmarks

```bash
# Full v2.0 validation suite
virnucpro benchmark --suite v2-validation

# v1.0 vs v2.0 comparison (requires v1.0 git tag)
virnucpro benchmark --suite v1-comparison

# Multi-GPU scaling test
virnucpro benchmark --suite v2-scaling

# Parameter optimization sweep
virnucpro benchmark --suite v2-throughput
```

### Environment Variables

| Variable | Purpose | Default |
|----------|---------|---------|
| `VIRNUCPRO_DISABLE_FP16` | Force FP32 precision in v2.0 ESM-2 | unset (FP16 enabled) |
| `VIRNUCPRO_DISABLE_PACKING` | Disable sequence packing in v2.0 ESM-2 | unset (packing enabled) |

## Deprecation Timeline

- **v2.0 (current)**: `--v1-fallback` available, v1.0 ESM-2 code remains. DNABERT-S uses v1.0.
- **v2.1 (planned)**: DNABERT-S v2.0 support added. `--v1-fallback` emits deprecation warning.
- **v3.0 (future)**: v1.0 code removed, `--v1-fallback` removed.

## Error Handling (v2.0 ESM-2)

v2.0 uses **fail-fast** error handling for ESM-2:
- If any GPU worker fails during ESM-2 embedding, the entire stage fails with RuntimeError
- This is different from v1.0 which tracked individual file failures
- Rationale: v2.0 distributes sequences across GPUs by stride, so a failed worker means
  missing every Nth sequence, which would corrupt downstream predictions

## Troubleshooting

### v2.0 crashes but v1.0 works
```bash
# Temporary: use v1.0 while investigating
python -m virnucpro predict input.fasta --parallel --v1-fallback

# Check if FP16 issue:
VIRNUCPRO_DISABLE_FP16=true python -m virnucpro predict input.fasta --parallel

# Check if packing issue:
VIRNUCPRO_DISABLE_PACKING=true python -m virnucpro predict input.fasta --parallel
```

### GPU Out of Memory in v2.0
v2.0 uses dynamic token budgets for ESM-2. If OOM occurs:
1. The system automatically adjusts batch size based on GPU memory
2. Emergency: set `VIRNUCPRO_DISABLE_PACKING=true` to reduce memory usage
3. Emergency: set `VIRNUCPRO_DISABLE_FP16=true` (counter-intuitive but may help with memory fragmentation)
```

Write the above content as-is. This covers all success criteria items related to the migration guide, including the hybrid architecture (Issue 5), DNABERT-S v1.0 rationale, and v2.1 future work note.
  </action>
  <verify>
    test -f docs/MIGRATION_v2.md && wc -l docs/MIGRATION_v2.md | awk '{print $1 " lines"}'
    grep -c "v1-fallback\|hybrid\|DNABERT-S.*v1.0\|v2.1" docs/MIGRATION_v2.md
    grep "DNABERT-S embedding.*v1.0" docs/MIGRATION_v2.md
  </verify>
  <done>
    Migration guide documents: hybrid architecture (ESM-2 v2.0, DNABERT-S v1.0 with rationale), architecture changes (multi-worker to async DataLoader for ESM-2 only), CLI changes (no breaking changes, --v1-fallback added), deprecated options (--esm-batch-size ignored, --dnabert-batch-size still used), new capabilities (ESM-2 only), migration steps, environment variables, fail-fast error handling, deprecation timeline with v2.1 DNABERT-S note, and troubleshooting. File exists at docs/MIGRATION_v2.md with 100+ lines.
  </done>
</task>

</tasks>

<verification>
- `python -m virnucpro benchmark --help` shows v2-validation, v2-scaling, v2-throughput, v1-comparison suites
- `test -f docs/MIGRATION_v2.md` migration guide exists
- `grep "v1-fallback" docs/MIGRATION_v2.md` documents the fallback flag
- `grep "deprecated" docs/MIGRATION_v2.md` documents deprecated options
- `grep "hybrid" docs/MIGRATION_v2.md` documents hybrid architecture
- `grep "DNABERT-S.*v1.0" docs/MIGRATION_v2.md` confirms DNABERT stays v1.0
- `grep "v2.1" docs/MIGRATION_v2.md` notes future DNABERT-S v2.0 work
</verification>

<success_criteria>
Benchmark CLI exposes Phase 10 validation tests via `--suite` option with v2-validation, v2-scaling, v2-throughput, and v1-comparison choices. Migration guide at `docs/MIGRATION_v2.md` accurately documents hybrid architecture (ESM-2 v2.0, DNABERT-S v1.0), explains why DNABERT-S stays v1.0, notes v2.1 future work, documents --v1-fallback flag, deprecated options, fail-fast error handling, environment variables, deprecation timeline, and troubleshooting steps. Existing benchmark suites unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/10.1-cli-integration-for-v2-0-architecture/10.1-02-SUMMARY.md`
</output>
