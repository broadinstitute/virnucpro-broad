---
phase: 01-esm-2-multi-gpu-foundation
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - virnucpro/pipeline/parallel_esm.py
  - virnucpro/pipeline/work_queue.py
  - virnucpro/pipeline/features.py
  - virnucpro/core/logging_setup.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "BF16 mixed precision logs are visible when enabled on Ampere+ GPUs"
    - "Main process logs GPU capabilities before spawning workers"
    - "Worker processes inherit proper logging configuration"
  artifacts:
    - path: "virnucpro/pipeline/parallel_esm.py"
      provides: "Worker logging initialization"
      contains: "setup_logging"
    - path: "virnucpro/pipeline/work_queue.py"
      provides: "Logging config passed to workers"
      contains: "log_level"
    - path: "virnucpro/core/logging_setup.py"
      provides: "Worker-safe logging setup"
      exports: ["setup_worker_logging"]
  key_links:
    - from: "work_queue.py"
      to: "worker kwargs"
      via: "Pass log level/format to workers"
      pattern: "log_level.*=.*logging"
    - from: "parallel_esm.py worker"
      to: "logging_setup"
      via: "Initialize logging in worker"
      pattern: "setup.*logging"
---

<objective>
Fix BF16 logging visibility by configuring logging in spawned worker processes and adding main process GPU capability logging.

Purpose: Users need to see BF16 mixed precision status to verify GPU optimizations are active.
Output: Visible BF16 logs and GPU capability information in both main and worker processes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-UAT.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-01-SUMMARY.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worker-safe logging setup function</name>
  <files>virnucpro/core/logging_setup.py</files>
  <action>
    Create a new function setup_worker_logging that:
    1. Takes log_level (int) and log_format (str) parameters
    2. Configures the root logger with the provided level and format
    3. Also configures module-specific loggers (virnucpro.*) with same level
    4. Ensures console handler is added if not present
    5. Is safe to call in multiprocessing spawn context

    This function will be called at the start of each worker process to ensure logging is properly configured.

    Gap reason from UAT: "Logging setup not designed for multiprocessing workers"
  </action>
  <verify>python -c "from virnucpro.core.logging_setup import setup_worker_logging; import logging; setup_worker_logging(logging.INFO, '%(message)s')"</verify>
  <done>Worker-safe logging function exists and is importable</done>
</task>

<task type="auto">
  <name>Task 2: Pass logging config to workers and initialize</name>
  <files>virnucpro/pipeline/work_queue.py, virnucpro/pipeline/parallel_esm.py</files>
  <action>
    In virnucpro/pipeline/work_queue.py:
    1. Import logging module at top
    2. In BatchQueueManager.process_files(), add to kwargs:
       - log_level=logging.getLogger().level
       - log_format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    3. Pass these kwargs to worker_func

    In virnucpro/pipeline/parallel_esm.py:
    1. Import setup_worker_logging from virnucpro.core.logging_setup
    2. At the start of process_esm_files_worker function:
       - Extract log_level and log_format from kwargs (with defaults)
       - Call setup_worker_logging(log_level, log_format)
    3. Existing BF16 logging at INFO level will now be visible

    Gap reason from UAT: "Worker function lacks logging configuration initialization"
  </action>
  <verify>grep -n "setup_worker_logging" virnucpro/pipeline/parallel_esm.py && grep -n "log_level" virnucpro/pipeline/work_queue.py</verify>
  <done>Workers receive and initialize logging configuration</done>
</task>

<task type="auto">
  <name>Task 3: Add main process GPU capability logging</name>
  <files>virnucpro/pipeline/features.py</files>
  <action>
    In extract_esm_features_parallel function (before spawning workers):
    1. After GPU list is determined, log GPU capabilities:
       - For each GPU ID, get the device name and compute capability
       - Log whether BF16 will be enabled (compute >= 8.0)
       - Example: "GPU 0 (NVIDIA RTX 4090): Compute 8.9, BF16 enabled"
    2. Log the batch size that will be used based on BF16 status
    3. This ensures users see GPU info before workers start

    This provides visibility into GPU detection and BF16 status at the main process level.

    Gap reason from UAT: "Add main process log showing GPU capabilities and BF16 status before spawning workers"
  </action>
  <verify>python -c "import torch; print(f'GPU 0: {torch.cuda.get_device_name(0)}, Compute: {torch.cuda.get_device_capability(0)}')"</verify>
  <done>Main process logs GPU capabilities and BF16 status</done>
</task>

</tasks>

<verification>
1. Run pipeline and check logs show GPU capabilities in main process
2. Check worker logs show "BF16 enabled" messages at INFO level
3. Verify batch size logs show 3072 for BF16, 2048 for FP32
4. Test with VIRNUCPRO_LOG_LEVEL=DEBUG to verify detailed logging works
</verification>

<success_criteria>
- GPU capabilities logged in main process before workers spawn
- BF16 status visible in worker process logs
- Batch size selection based on BF16 is logged
- Logging configuration properly inherited by workers
</success_criteria>

<output>
After completion, create `.planning/phases/01-esm-2-multi-gpu-foundation/01-06-SUMMARY.md`
</output>