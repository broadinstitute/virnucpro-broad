---
phase: 01-esm-2-multi-gpu-foundation
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - virnucpro/cli/predict.py
  - virnucpro/pipeline/prediction.py
  - virnucpro/pipeline/parallel.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Running virnucpro predict on a multi-GPU system without specifying GPU flags automatically uses all available GPUs"
    - "GPU detection happens early in the pipeline and enables parallel mode automatically"
    - "Single-GPU systems continue to work without code changes"
  artifacts:
    - path: "virnucpro/cli/predict.py"
      provides: "Auto-detection logic for multi-GPU systems"
      contains: "detect_cuda_devices"
    - path: "virnucpro/pipeline/prediction.py"
      provides: "Parallel mode auto-enable for DNABERT-S"
      contains: "parallel=True"
  key_links:
    - from: "virnucpro/cli/predict.py"
      to: "detect_cuda_devices()"
      via: "Import and early detection"
      pattern: "detect_cuda_devices"
    - from: "predict.py detection"
      to: "args.parallel"
      via: "Auto-set parallel flag"
      pattern: "args\\.parallel.*=.*True"
---

<objective>
Fix multi-GPU auto-detection to automatically enable parallel processing when multiple GPUs are available without requiring user flags.

Purpose: Users expect multi-GPU systems to automatically utilize all available GPUs for ESM-2 extraction.
Output: Modified CLI and pipeline that auto-detects and uses all GPUs by default.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-UAT.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-01-SUMMARY.md
@.planning/phases/01-esm-2-multi-gpu-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add early GPU detection and auto-enable parallel mode</name>
  <files>virnucpro/cli/predict.py</files>
  <action>
    Modify the predict command to:
    1. Import detect_cuda_devices from virnucpro.pipeline.parallel at the top
    2. After argument parsing, detect available GPUs if --gpus not specified
    3. If multiple GPUs detected and --gpus not specified:
       - Set args.gpus to the detected GPU list (e.g., "0,1,2,3")
       - Set args.parallel = True (override the default False)
    4. Log the auto-detection: "Detected N GPUs, enabling parallel processing"
    5. Keep existing logic where --gpus with multiple IDs also enables parallel

    Reference from 01-03-SUMMARY.md:
    - Lines 54-60 show --parallel defaults to False
    - Lines 104-112 show auto-enable only when --gpus has multiple IDs

    Gap reason from UAT: "The --parallel flag defaults to False, preventing automatic multi-GPU detection. GPU detection logic only executes when parallel=True."
  </action>
  <verify>grep -n "detect_cuda_devices" virnucpro/cli/predict.py && grep -n "args.parallel = True" virnucpro/cli/predict.py</verify>
  <done>CLI auto-detects multiple GPUs and sets parallel=True without user flags</done>
</task>

<task type="auto">
  <name>Task 2: Update DNABERT-S pipeline for auto-parallel mode</name>
  <files>virnucpro/pipeline/prediction.py, virnucpro/pipeline/parallel.py</files>
  <action>
    In virnucpro/pipeline/prediction.py:
    1. Update DNABERT-S section (lines 222-233) to match ESM-2's parallel detection
    2. Ensure parallel mode is enabled when args.parallel is True
    3. Add logging to show DNABERT-S using multi-GPU mode

    In virnucpro/pipeline/parallel.py:
    1. Ensure detect_cuda_devices() is exported and properly handles single-GPU case
    2. Return empty list for single GPU, list of GPU IDs for multiple
    3. Handle CUDA not available gracefully (return empty list)

    Gap reason from UAT: "Lines 222-233 (DNABERT) and 326-330 (ESM-2) require parallel=True to enable multi-GPU mode"
  </action>
  <verify>python -c "from virnucpro.pipeline.parallel import detect_cuda_devices; print(detect_cuda_devices())"</verify>
  <done>DNABERT-S pipeline respects auto-enabled parallel mode</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for auto-detection behavior</name>
  <files>tests/test_cli_predict.py</files>
  <action>
    Create or update test file to verify:
    1. Mock detect_cuda_devices to return ["0", "1"] for multi-GPU test
    2. Test that predict command with no --gpus flag sets parallel=True when multiple GPUs detected
    3. Mock to return ["0"] for single-GPU test
    4. Test that single GPU doesn't enable parallel mode
    5. Test that explicit --gpus flag overrides auto-detection

    Use unittest.mock to patch detect_cuda_devices for predictable testing.
  </action>
  <verify>python -m pytest tests/test_cli_predict.py -v -k "auto_detect"</verify>
  <done>Tests verify multi-GPU auto-detection works correctly</done>
</task>

</tasks>

<verification>
1. Run `virnucpro predict --help` to verify CLI still works
2. Run `python -c "from virnucpro.pipeline.parallel import detect_cuda_devices; print(detect_cuda_devices())"` to verify GPU detection
3. Check logs show "Detected N GPUs, enabling parallel processing" when run without --gpus flag
4. Verify single-GPU systems still work without parallel mode
</verification>

<success_criteria>
- Multi-GPU systems automatically use all GPUs without --gpus or --parallel flags
- Single-GPU systems continue to work without changes
- Auto-detection is logged clearly for user visibility
- Tests verify both multi-GPU and single-GPU scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/01-esm-2-multi-gpu-foundation/01-05-SUMMARY.md`
</output>