---
phase: 02-dnabert-s-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [virnucpro/pipeline/base_worker.py, virnucpro/pipeline/parallel_dnabert.py]
autonomous: true

must_haves:
  truths:
    - "Users can process DNA sequences across multiple GPUs simultaneously"
    - "Processing automatically uses optimal batch sizes based on GPU capabilities"
    - "DNA sequence extraction completes 3-4x faster with 4 GPUs"
    - "All GPUs show balanced utilization during processing"
    - "Results are identical whether using 1 GPU or multiple GPUs"
  artifacts:
    - path: "virnucpro/pipeline/base_worker.py"
      provides: "Abstract base class for embedding workers"
      min_lines: 80
      exports: ["BaseEmbeddingWorker"]
    - path: "virnucpro/pipeline/parallel_dnabert.py"
      provides: "DNABERT-S parallel processing implementation"
      min_lines: 200
      exports: ["process_dnabert_files_worker", "count_sequences", "assign_files_by_sequences"]
  key_links:
    - from: "virnucpro/pipeline/parallel_dnabert.py"
      to: "virnucpro/pipeline/base_worker.py"
      via: "inheritance"
      pattern: "class.*BaseEmbeddingWorker"
    - from: "virnucpro/pipeline/parallel_dnabert.py"
      to: "torch.cuda"
      via: "BF16 detection"
      pattern: "get_device_capability"
---

<objective>
Create the foundational BaseEmbeddingWorker abstraction and implement DNABERT-S parallel processing with token-based batching and BF16 optimization.

Purpose: Establish unified worker interface and enable DNABERT-S to process files across multiple GPUs with the same optimization level as ESM-2.
Output: Base worker class and fully functional DNABERT-S parallel worker with automatic BF16 detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dnabert-s-optimization/02-RESEARCH.md
@.planning/phases/02-dnabert-s-optimization/02-CONTEXT.md

# Existing ESM-2 patterns to follow
@virnucpro/pipeline/parallel_esm.py
@virnucpro/pipeline/work_queue.py
@virnucpro/pipeline/features.py
@virnucpro/core/device.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BaseEmbeddingWorker abstract class</name>
  <files>virnucpro/pipeline/base_worker.py</files>
  <action>
    Create an abstract base class that defines the unified interface for embedding workers.

    The class should:
    - Use ABC (abstract base class) for interface enforcement
    - Define abstract methods: process_files_worker(), get_optimal_batch_size()
    - Include shared utilities: count_sequences(), assign_files_by_sequences()
    - Support progress reporting via multiprocessing.Queue
    - Handle BF16 detection logic (shared by both models)
    - Include logging setup for workers

    Key design decisions:
    - Method signature must match existing pattern: process_files_worker(file_subset, device_id, batch_size, output_dir, **kwargs)
    - Return type: Tuple[List[Path], List[Tuple[Path, str]]] for (processed, failed)
    - BF16 detection should use torch.cuda.get_device_capability() matching existing pattern
    - Use spawn context compatibility (no instance methods that can't be pickled)
  </action>
  <verify>grep -n "class BaseEmbeddingWorker" virnucpro/pipeline/base_worker.py && grep -n "@abstractmethod" virnucpro/pipeline/base_worker.py</verify>
  <done>base_worker.py exists with BaseEmbeddingWorker class defining process_files_worker and get_optimal_batch_size abstract methods</done>
</task>

<task type="auto">
  <name>Task 2: Implement DNABERT-S parallel worker</name>
  <files>virnucpro/pipeline/parallel_dnabert.py</files>
  <action>
    Create the DNABERT-S parallel processing implementation following ESM-2 patterns but adapted for DNA sequences.

    Implementation requirements:
    - Import and extend BaseEmbeddingWorker (once it exists)
    - Implement process_dnabert_files_worker() with same signature as ESM-2
    - Use token-based batching (treat DNA bases as tokens, abstract k-mer complexity)
    - Enable BF16 mixed precision on Ampere+ GPUs (compute capability >= 8)
    - Use torch.no_grad() context for all inference
    - Implement deferred CUDA initialization (only in worker process, not parent)
    - Support progress reporting via queue (matching ESM-2 pattern)
    - Use spawn context for CUDA safety

    Batching strategy:
    - Count tokens as sequence length (each base = ~1 token)
    - Default batch size: 2048 tokens (increase to 3072 with BF16)
    - Dynamic batching: accumulate sequences until token limit reached

    Error handling:
    - Catch and log per-file errors, continue processing
    - Return (processed_files, failed_files) tuple
    - Include device context in error messages

    Reference parallel_esm.py for patterns but adapt for DNABERT-S model loading and tokenization.
  </action>
  <verify>grep -n "process_dnabert_files_worker" virnucpro/pipeline/parallel_dnabert.py && grep -n "torch.no_grad" virnucpro/pipeline/parallel_dnabert.py && grep -n "BF16" virnucpro/pipeline/parallel_dnabert.py</verify>
  <done>parallel_dnabert.py exists with process_dnabert_files_worker function implementing token-based batching and BF16 optimization</done>
</task>

<task type="auto">
  <name>Task 3: Add bin-packing file assignment for DNABERT-S</name>
  <files>virnucpro/pipeline/parallel_dnabert.py</files>
  <action>
    Add the sequence-based bin-packing algorithm to parallel_dnabert.py for balanced GPU utilization.

    Implementation:
    - Port assign_files_round_robin() from parallel_esm.py but rename to assign_files_by_sequences()
    - Use greedy bin-packing: assign each file to worker with lowest current sequence count
    - Count sequences in FASTA files (count lines starting with '>')
    - Sort files by sequence count (descending) before bin-packing
    - Log the assignment distribution showing files and sequences per worker

    This ensures GPUs get balanced work based on actual compute (sequence count) not just file count.
  </action>
  <verify>grep -n "assign_files_by_sequences" virnucpro/pipeline/parallel_dnabert.py && grep -n "bin-packing" virnucpro/pipeline/parallel_dnabert.py</verify>
  <done>parallel_dnabert.py includes assign_files_by_sequences function with bin-packing algorithm</done>
</task>

</tasks>

<verification>
1. Check BaseEmbeddingWorker class exists with correct abstract methods
2. Verify DNABERT-S worker implements the base class interface
3. Confirm BF16 detection logic is present
4. Verify token-based batching implementation
5. Check bin-packing assignment function exists
</verification>

<success_criteria>
- BaseEmbeddingWorker abstract class created with unified interface
- DNABERT-S parallel worker implemented with token-based batching
- BF16 optimization automatically enabled on compatible GPUs
- Bin-packing algorithm balances sequences across workers
- Code follows established patterns from ESM-2 implementation
</success_criteria>

<output>
After completion, create `.planning/phases/02-dnabert-s-optimization/02-01-SUMMARY.md`
</output>