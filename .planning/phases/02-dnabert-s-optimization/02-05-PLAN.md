---
phase: 02-dnabert-s-optimization
plan: 05
type: execute
wave: 5
depends_on: [02-04]
files_modified: [tests/test_integration_dnabert_multi_gpu.py, docs/optimization_guide.md]
autonomous: false

must_haves:
  truths:
    - "Integration tests verify DNABERT-S multi-GPU processing"
    - "Tests compare optimized vs vanilla output for correctness"
    - "Documentation explains optimization settings"
    - "Performance metrics demonstrate 3-4x improvement"
  artifacts:
    - path: "tests/test_integration_dnabert_multi_gpu.py"
      provides: "End-to-end integration tests for DNABERT-S"
      min_lines: 200
      exports: ["TestDNABERTMultiGPUIntegration"]
    - path: "docs/optimization_guide.md"
      provides: "User guide for GPU optimization"
      min_lines: 150
      contains: "DNABERT-S Optimization"
  key_links:
    - from: "tests/test_integration_dnabert_multi_gpu.py"
      to: "virnucpro predict"
      via: "subprocess call"
      pattern: "subprocess.run.*virnucpro predict"
    - from: "docs/optimization_guide.md"
      to: "batch size tuning"
      via: "documentation"
      pattern: "--dnabert-batch-size"
---

<objective>
Create comprehensive integration tests for DNABERT-S multi-GPU processing and documentation for users, then verify performance improvements.

Purpose: Validate the complete DNABERT-S optimization implementation and provide users with clear guidance on leveraging the improvements.
Output: Integration tests proving correctness and performance gains, plus user documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous implementation work
@.planning/phases/02-dnabert-s-optimization/02-01-SUMMARY.md
@.planning/phases/02-dnabert-s-optimization/02-02-SUMMARY.md
@.planning/phases/02-dnabert-s-optimization/02-03-SUMMARY.md
@.planning/phases/02-dnabert-s-optimization/02-04-SUMMARY.md

# Existing test patterns
@tests/test_integration_multi_gpu.py
@tests/test_cli_predict.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DNABERT-S multi-GPU integration tests</name>
  <files>tests/test_integration_dnabert_multi_gpu.py</files>
  <action>
    Create comprehensive end-to-end integration tests for DNABERT-S multi-GPU processing.

    Test structure following test_integration_multi_gpu.py patterns:

    1. Test multi-GPU DNABERT-S extraction:
       - test_dnabert_multi_gpu_extraction() - Verify parallel processing works
       - test_dnabert_single_gpu_fallback() - Verify fallback when 1 GPU
       - test_dnabert_cpu_fallback() - Verify CPU fallback when no GPUs

    2. Test output correctness:
       - test_dnabert_parallel_matches_sequential() - Compare outputs byte-for-byte
       - test_dnabert_feature_dimensions() - Verify embedding dimensions correct
       - test_dnabert_deterministic_output() - Same input produces same output

    3. Test CLI integration:
       - test_cli_dnabert_batch_size_flag() - Verify --dnabert-batch-size works
       - test_cli_auto_parallel_detection() - Verify auto-enables on multi-GPU
       - test_cli_explicit_gpu_selection() - Verify --gpus flag works

    4. Test performance improvements:
       - test_dnabert_throughput_improvement() - Measure speedup with assertion >= 3.0x
       - test_dnabert_gpu_utilization() - Verify GPUs are actually being used
       - test_dnabert_memory_efficiency() - Verify BF16 reduces memory

    5. Test error handling:
       - test_dnabert_partial_failure_handling() - Some files fail, others succeed
       - test_dnabert_oom_recovery() - Handle out-of-memory gracefully

    Performance test assertions:
    - Assert throughput improvement >= 3.0x with 4 GPUs
    - Use specific thresholds not vague "improvements"

    Use subprocess to test actual CLI (matching test_cli_predict.py pattern).
    Create small test FASTA files to keep tests fast.
    Mock where appropriate but test real multi-GPU flow when possible.
  </action>
  <verify>python -m pytest tests/test_integration_dnabert_multi_gpu.py::test_dnabert_throughput_improvement -v</verify>
  <done>Integration tests created with specific performance assertions (>= 3.0x improvement)</done>
</task>

<task type="auto">
  <name>Task 2: Create optimization guide documentation</name>
  <files>docs/optimization_guide.md</files>
  <action>
    Write comprehensive documentation explaining the GPU optimization features for users.

    Documentation structure:

    # GPU Optimization Guide

    ## Overview
    - Brief introduction to the optimization improvements
    - Performance gains summary (45+ hours -> <10 hours)

    ## Quick Start
    - Zero-config multi-GPU: just run `virnucpro predict`
    - Auto-detection of GPUs and optimal settings

    ## DNABERT-S Optimization

    ### Automatic Features
    - Multi-GPU parallelization with auto-detection
    - BF16 mixed precision on Ampere+ GPUs
    - Token-based dynamic batching
    - Bin-packing work distribution

    ### Manual Tuning
    - --dnabert-batch-size flag (default: 2048, BF16: 3072)
    - When to increase/decrease batch size
    - Memory vs throughput tradeoffs

    ### Profiling Your Hardware
    ```python
    from virnucpro.pipeline.profiler import profile_dnabert_batch_size
    optimal = profile_dnabert_batch_size(device='cuda:0')
    ```

    Or via CLI:
    ```bash
    virnucpro profile --model dnabert-s --device cuda:0
    ```

    ## ESM-2 Optimization
    - Similar section for ESM-2 (reference Phase 1 work)
    - --esm-batch-size flag

    ## GPU Selection
    - --gpus flag for explicit GPU selection
    - Examples: --gpus 0,1,2,3 or --gpus 2,3

    ## Performance Metrics
    - Expected speedups by GPU count
    - Memory usage guidelines
    - Monitoring GPU utilization

    ## Troubleshooting
    - Out of memory errors -> reduce batch size
    - Unbalanced GPU usage -> check sequence distribution
    - No speedup -> verify multi-GPU enabled in logs

    ## Examples
    - Basic multi-GPU: `virnucpro predict -n nucleotides.fa -p proteins.fa -o results/`
    - Tuned batch sizes: `virnucpro predict ... --dnabert-batch-size 4096 --esm-batch-size 4096`
    - Specific GPUs: `virnucpro predict ... --gpus 0,1`
    - Profile first: `virnucpro profile --model dnabert-s`
  </action>
  <verify>grep -n "DNABERT-S Optimization" docs/optimization_guide.md && grep -n "virnucpro profile" docs/optimization_guide.md</verify>
  <done>Optimization guide created with clear explanations and profiler integration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>DNABERT-S multi-GPU optimization with parallel processing, BF16 support, profiling tools, and integration tests</what-built>
  <how-to-verify>
    1. Run the integration tests to verify functionality:
       ```bash
       python -m pytest tests/test_integration_dnabert_multi_gpu.py -v
       ```

    2. Test the profiler to find optimal batch size:
       ```bash
       virnucpro profile --model dnabert-s --device cuda:0
       ```

    3. Test the actual pipeline with DNABERT-S optimization:
       ```bash
       # Create small test files if needed
       virnucpro predict -n test_data/nucleotides.fa -p test_data/proteins.fa -o test_output/ --gpus 0,1
       ```

    4. Check the logs for:
       - "Using parallel DNABERT-S processing with X GPUs"
       - "Using BF16 mixed precision" (if you have Ampere+ GPU)
       - Processing time improvements

    5. Test batch size tuning:
       ```bash
       virnucpro predict ... --dnabert-batch-size 4096
       ```

    6. Review the optimization guide:
       ```bash
       cat docs/optimization_guide.md
       ```

    Expected outcomes:
    - DNABERT-S processes files in parallel across GPUs
    - 3-4x throughput improvement with 4 GPUs (verified by tests)
    - BF16 automatically enabled on compatible hardware
    - Profiler provides concrete batch size recommendations
    - Documentation clearly explains all features
  </how-to-verify>
  <resume-signal>Type "approved" after verifying DNABERT-S optimization works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Run full test suite including new DNABERT-S tests
2. Manually test multi-GPU DNABERT-S extraction
3. Verify performance improvements meet 3-4x target
4. Check documentation is clear and complete
5. Test profiler provides useful recommendations
</verification>

<success_criteria>
- Integration tests pass demonstrating correct multi-GPU DNABERT-S processing
- Performance tests show >= 3.0x throughput improvement (specific assertion)
- Optimized output matches vanilla output exactly
- Profiler accessible via CLI and provides recommendations
- Documentation provides clear guidance for users
- Human verification confirms the optimization works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/02-dnabert-s-optimization/02-05-SUMMARY.md`
</output>