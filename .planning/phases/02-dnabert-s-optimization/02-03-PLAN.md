---
phase: 02-dnabert-s-optimization
plan: 03
type: execute
wave: 3
depends_on: [02-01, 02-02]
files_modified: [virnucpro/pipeline/prediction.py, virnucpro/cli/predict.py]
autonomous: true

must_haves:
  truths:
    - "Pipeline automatically uses parallel DNABERT-S when multiple GPUs available"
    - "CLI accepts --dnabert-batch-size flag for tuning"
    - "Sequential execution order maintained (DNABERT-S then ESM-2)"
    - "Batch size parameter flows correctly from CLI to worker"
  artifacts:
    - path: "virnucpro/pipeline/prediction.py"
      provides: "Updated pipeline with parallel DNABERT-S integration"
      contains: "from virnucpro.pipeline.parallel_dnabert import"
    - path: "virnucpro/cli/predict.py"
      provides: "CLI with --dnabert-batch-size flag"
      contains: "--dnabert-batch-size"
  key_links:
    - from: "virnucpro/pipeline/prediction.py"
      to: "virnucpro/pipeline/parallel_dnabert.py"
      via: "import and usage"
      pattern: "process_dnabert_files_worker"
    - from: "virnucpro/cli/predict.py"
      to: "virnucpro/pipeline/prediction.py"
      via: "parameter passing"
      pattern: "dnabert_batch_size"
---

<objective>
Integrate parallel DNABERT-S into the prediction pipeline with CLI support for batch size tuning.

Purpose: Enable users to leverage multi-GPU DNABERT-S processing with tunable batch sizes.
Output: Updated pipeline using parallel DNABERT-S and CLI flag for batch size control.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plans' outputs
@.planning/phases/02-dnabert-s-optimization/02-01-SUMMARY.md
@.planning/phases/02-dnabert-s-optimization/02-02-SUMMARY.md

# Files to integrate with
@virnucpro/pipeline/prediction.py
@virnucpro/cli/predict.py
@virnucpro/pipeline/work_queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate parallel DNABERT-S into prediction pipeline</name>
  <files>virnucpro/pipeline/prediction.py</files>
  <action>
    Update the prediction pipeline to use parallel DNABERT-S processing when multiple GPUs are available.

    Integration points:
    1. Import parallel DNABERT-S functions:
       - from virnucpro.pipeline.parallel_dnabert import process_dnabert_files_worker, assign_files_by_sequences
       - from virnucpro.pipeline.work_queue import BatchQueueManager

    2. Modify DNABERT-S extraction logic:
       - Check if parallel processing enabled (multiple GPUs or --parallel flag)
       - If parallel: use BatchQueueManager with process_dnabert_files_worker
       - If not: fall back to existing sequential extraction
       - Match the pattern used for ESM-2 parallel processing

    3. Maintain sequential execution order:
       - Translation completes first (if using parallel translation)
       - Then DNABERT-S extraction (parallel if available)
       - Then ESM-2 extraction (parallel if available)
       - Finally prediction on merged features

    4. Handle batch size parameter:
       - Accept dnabert_batch_size parameter (default: 2048)
       - Pass to worker function for token-based batching
       - Ensure parameter flows through all function calls

    5. GPU assignment:
       - Use same GPU list for both DNABERT-S and ESM-2
       - Auto-detect if not specified (matching Phase 1 pattern)

    Preserve all existing functionality - this should be additive, not breaking.
  </action>
  <verify>grep -n "from virnucpro.pipeline.parallel_dnabert" virnucpro/pipeline/prediction.py && grep -n "process_dnabert_files_worker" virnucpro/pipeline/prediction.py && grep -n "dnabert_batch_size" virnucpro/pipeline/prediction.py</verify>
  <done>prediction.py updated to use parallel DNABERT-S with automatic GPU detection and batch size parameter</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI support for DNABERT-S batch size with parameter wiring</name>
  <files>virnucpro/cli/predict.py</files>
  <action>
    Add command-line flag for DNABERT-S batch size tuning, matching ESM-2 pattern, with explicit parameter wiring verification.

    CLI additions:
    1. Add --dnabert-batch-size argument:
       - Type: int
       - Default: 2048
       - Help: "Token batch size for DNABERT-S processing (default: 2048, with BF16: 3072)"
       - Place near --esm-batch-size for consistency

    2. Wire parameter through the call chain:
       - Extract args.dnabert_batch_size from argparse
       - Pass dnabert_batch_size to the predict pipeline function call
       - Verify parameter reaches prediction.py's dnabert_batch_size parameter
       - Ensure it flows to the parallel_dnabert worker

    3. Parameter flow verification:
       - CLI argparse -> predict function -> pipeline -> worker
       - Log the batch size value at each stage for debugging
       - Ensure no parameter is lost in translation

    4. Update help text:
       - Document that both --dnabert-batch-size and --esm-batch-size can be tuned
       - Note that BF16 automatically increases defaults when available

    Follow the exact pattern used for --esm-batch-size implementation.
  </action>
  <verify>grep -n "dnabert-batch-size" virnucpro/cli/predict.py && python -m virnucpro predict --help | grep "dnabert-batch-size" && grep -n "dnabert_batch_size=args.dnabert_batch_size" virnucpro/cli/predict.py</verify>
  <done>CLI updated with --dnabert-batch-size flag and explicit parameter wiring verified</done>
</task>

</tasks>

<verification>
1. Test parallel DNABERT-S integration in pipeline
2. Verify CLI flag is recognized and passed through
3. Trace parameter flow from CLI to worker
4. Confirm backward compatibility maintained
</verification>

<success_criteria>
- Pipeline uses parallel DNABERT-S when multiple GPUs available
- --dnabert-batch-size CLI flag works correctly
- Parameter flows correctly from CLI through pipeline to worker
- Sequential execution order maintained (DNABERT-S before ESM-2)
- No breaking changes to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-dnabert-s-optimization/02-03-SUMMARY.md`
</output>