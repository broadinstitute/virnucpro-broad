---
phase: 02-dnabert-s-optimization
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [virnucpro/pipeline/parallel_esm.py, tests/test_parallel_dnabert.py]
autonomous: true

must_haves:
  truths:
    - "ESM-2 worker inherits from BaseEmbeddingWorker"
    - "Shared utilities moved to base class"
    - "DNABERT-S worker has comprehensive unit tests"
    - "Tests verify BF16 optimization and batching"
    - "Tests verify optimized output matches vanilla implementation"
  artifacts:
    - path: "virnucpro/pipeline/parallel_esm.py"
      provides: "Refactored ESM-2 worker using base class"
      contains: "from virnucpro.pipeline.base_worker import"
    - path: "tests/test_parallel_dnabert.py"
      provides: "Unit tests for DNABERT-S parallel processing"
      min_lines: 150
      exports: ["TestParallelDNABERT"]
  key_links:
    - from: "virnucpro/pipeline/parallel_esm.py"
      to: "virnucpro/pipeline/base_worker.py"
      via: "import"
      pattern: "from.*base_worker import"
    - from: "tests/test_parallel_dnabert.py"
      to: "virnucpro/pipeline/parallel_dnabert.py"
      via: "testing imports"
      pattern: "from.*parallel_dnabert import"
---

<objective>
Refactor ESM-2 worker to use BaseEmbeddingWorker and create comprehensive tests for DNABERT-S parallel processing, including vanilla comparison.

Purpose: Ensure consistency between workers through shared base class and validate DNABERT-S implementation with thorough testing that confirms optimized output matches non-optimized.
Output: Refactored ESM-2 using base class and complete test coverage for DNABERT-S worker.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Files created in previous plan
@.planning/phases/02-dnabert-s-optimization/02-01-SUMMARY.md

# Existing test patterns to follow
@tests/test_parallel_esm.py
@tests/test_work_queue.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor ESM-2 worker to use BaseEmbeddingWorker</name>
  <files>virnucpro/pipeline/parallel_esm.py</files>
  <action>
    Refactor the existing ESM-2 worker to inherit from BaseEmbeddingWorker while maintaining backward compatibility.

    Changes needed:
    - Import BaseEmbeddingWorker from base_worker module
    - Remove duplicate utilities that now live in base class (count_sequences if moved)
    - Update class/function structure to use base class interface
    - Ensure process_esm_files_worker continues to work with existing code
    - Keep the specialized assign_files_round_robin if it differs from base

    Important:
    - Maintain exact same function signature for process_esm_files_worker
    - Don't break existing imports or function calls
    - Keep ESM-2 specific optimizations (like toks_per_batch parameter)
    - Preserve all existing logging and error handling

    This is a refactoring - the external interface must remain unchanged.
  </action>
  <verify>grep -n "from virnucpro.pipeline.base_worker import" virnucpro/pipeline/parallel_esm.py && python -c "from virnucpro.pipeline.parallel_esm import process_esm_files_worker"</verify>
  <done>parallel_esm.py refactored to use BaseEmbeddingWorker while maintaining backward compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive unit tests for DNABERT-S parallel worker</name>
  <files>tests/test_parallel_dnabert.py</files>
  <action>
    Create thorough unit tests for the DNABERT-S parallel processing functionality.

    Test coverage should include:

    1. Test file assignment with bin-packing:
       - test_assign_files_by_sequences_single_worker()
       - test_assign_files_by_sequences_multiple_workers()
       - test_assign_files_by_sequences_empty_input()
       - test_assign_files_by_sequences_balancing()

    2. Test BF16 detection:
       - test_bf16_enabled_on_ampere() - Mock compute capability 8.0
       - test_bf16_disabled_on_older_gpu() - Mock compute capability 7.5
       - test_batch_size_increase_with_bf16() - Verify 2048 -> 3072

    3. Test worker function:
       - test_process_dnabert_files_worker_success() - Mock model, verify output
       - test_process_dnabert_files_worker_with_failures() - Some files fail
       - test_process_dnabert_files_worker_empty_input()

    4. Test token-based batching:
       - test_token_batching_respects_limit()
       - test_token_batching_handles_long_sequences()
       - test_optimized_batching_matches_vanilla_output() - CRITICAL: Compare optimized vs non-optimized output

    5. Test vanilla comparison (REQUIRED for TEST-03):
       - test_optimized_matches_vanilla_output() - Full comparison test
         * Load same test sequences
         * Process with optimized batching (BF16, token-based)
         * Process with vanilla implementation (no BF16, simple batching)
         * Compare outputs element-wise, assert they are identical
         * Use torch.allclose() with appropriate tolerances for numerical comparison

    Use unittest.mock to:
    - Mock CUDA device availability
    - Mock model loading (avoid actual model downloads)
    - Mock torch.cuda.get_device_capability()
    - Create temp FASTA files for testing

    Follow patterns from test_parallel_esm.py but adapt for DNABERT-S specifics.
  </action>
  <verify>python -m pytest tests/test_parallel_dnabert.py -v --tb=short -k "test_optimized_matches_vanilla_output"</verify>
  <done>test_parallel_dnabert.py created with comprehensive test coverage including vanilla comparison test</done>
</task>

<task type="auto">
  <name>Task 3: Add integration test for BaseEmbeddingWorker inheritance</name>
  <files>tests/test_parallel_dnabert.py</files>
  <action>
    Add integration tests that verify both ESM-2 and DNABERT-S workers properly implement the base class interface.

    Tests to add:
    - test_dnabert_implements_base_interface() - Verify all abstract methods implemented
    - test_worker_signature_compatibility() - Check method signatures match base class
    - test_return_type_consistency() - Verify both return (processed, failed) tuples

    These tests ensure the abstraction works correctly and both workers follow the same interface contract.
  </action>
  <verify>grep -n "test_dnabert_implements_base_interface" tests/test_parallel_dnabert.py</verify>
  <done>Integration tests added verifying base class interface implementation</done>
</task>

</tasks>

<verification>
1. Run tests to ensure DNABERT-S worker tests pass
2. Verify ESM-2 still works after refactoring
3. Check that both workers use the base class
4. Confirm test coverage for critical functionality
5. Verify vanilla comparison test exists and passes
</verification>

<success_criteria>
- ESM-2 worker refactored to use BaseEmbeddingWorker without breaking changes
- Comprehensive test suite for DNABERT-S parallel processing
- Tests cover BF16 optimization, token batching, and bin-packing
- Vanilla comparison test verifies identical outputs (TEST-03 requirement)
- All tests pass successfully
- Both workers follow unified interface from base class
</success_criteria>

<output>
After completion, create `.planning/phases/02-dnabert-s-optimization/02-02-SUMMARY.md`
</output>