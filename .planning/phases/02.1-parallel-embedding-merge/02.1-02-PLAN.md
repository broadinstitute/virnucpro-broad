---
phase: 02.1-parallel-embedding-merge
plan: 02
type: execute
wave: 2
depends_on: [02.1-01]
files_modified:
  - virnucpro/pipeline/prediction.py
  - virnucpro/cli/predict.py
  - virnucpro/core/config.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can control merge parallelism via --merge-threads CLI parameter"
    - "Pipeline Stage 7 uses parallel merge when multiple cores available"
    - "Single-core systems fall back to sequential merge automatically"
    - "Progress bar shows real-time merge status during Stage 7"
  artifacts:
    - path: "virnucpro/cli/predict.py"
      provides: "--merge-threads CLI parameter"
      contains: "--merge-threads"
    - path: "virnucpro/pipeline/prediction.py"
      provides: "Stage 7 parallel merge integration"
      contains: "parallel_merge_with_progress"
    - path: "virnucpro/core/config.py"
      provides: "merge_threads configuration option"
      contains: "merge_threads"
  key_links:
    - from: "prediction.py"
      to: "parallel_merge.parallel_merge_with_progress"
      via: "Stage 7 import and call"
      pattern: "from virnucpro.pipeline.parallel_merge import parallel_merge"
    - from: "predict.py CLI"
      to: "config.merge_threads"
      via: "parameter passing"
      pattern: "merge_threads.*click.option"
---

<objective>
Integrate parallel merge into the prediction pipeline with CLI control and automatic optimization.

Purpose: Enable users to control merge parallelism while providing automatic optimization for multi-core systems.
Output: Updated pipeline Stage 7 using parallel merge, CLI parameter for control, progress reporting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-parallel-embedding-merge/02.1-01-SUMMARY.md

# Current pipeline integration
@virnucpro/pipeline/prediction.py:560-590

# CLI structure reference
@virnucpro/cli/predict.py

# Config structure
@virnucpro/core/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add merge_threads configuration option</name>
  <files>virnucpro/core/config.py</files>
  <action>
    Add merge_threads parameter to PredictionConfig dataclass:

    1. Add field to PredictionConfig class:
       ```python
       merge_threads: Optional[int] = None  # Number of threads for parallel merge (default: cpu_count)
       ```

    2. Follow existing pattern for similar parameters (e.g., threads for translation if exists)

    3. Ensure optional with None default (auto-detects CPU count when None)

    This matches the pattern from Phase 1.1 where threads parameter was added for translation.
  </action>
  <verify>grep "merge_threads" virnucpro/core/config.py</verify>
  <done>config.py includes merge_threads parameter</done>
</task>

<task type="auto">
  <name>Task 2: Add --merge-threads CLI parameter</name>
  <files>virnucpro/cli/predict.py</files>
  <action>
    Add CLI option following existing patterns:

    1. Add Click option to predict command:
       ```python
       @click.option(
           '--merge-threads',
           type=click.IntRange(min=1),
           default=None,
           help='Number of CPU threads for parallel embedding merge (default: auto-detect)'
       )
       ```

    2. Pass parameter to run_prediction():
       - Add merge_threads to function signature
       - Include in PredictionConfig construction

    3. Follow pattern of existing thread parameters:
       - Look for --threads or similar existing options
       - Place new option near related performance options
       - Use IntRange validator to ensure positive values

    Reference --threads parameter added in Phase 1.1 for consistency.
  </action>
  <verify>virnucpro predict --help | grep -i merge-threads</verify>
  <done>CLI includes --merge-threads parameter with help text</done>
</task>

<task type="auto">
  <name>Task 3: Integrate parallel merge into Stage 7</name>
  <files>virnucpro/pipeline/prediction.py</files>
  <action>
    Replace sequential merge loop with parallel implementation:

    1. Import parallel merge at top of file (near other pipeline imports):
       ```python
       from virnucpro.pipeline.parallel_merge import parallel_merge_with_progress, parallel_merge_features
       ```

    2. Detect parallelization capability in Stage 7:
       ```python
       # Determine if we should use parallel merge
       merge_threads = config.merge_threads if config.merge_threads else os.cpu_count()
       use_parallel = merge_threads > 1 and len(nucleotide_feature_files) > 1
       ```

    3. Replace lines 573-581 (the sequential merge loop) with:
       ```python
       if use_parallel:
           logger.info(f"Using parallel merge with {merge_threads} workers")
           merged_feature_files = parallel_merge_with_progress(
               nucleotide_feature_files,
               protein_feature_files,
               merged_dir,
               num_workers=merge_threads,
               show_progress=show_progress
           )
       else:
           # Fallback to sequential merge for single file or single core
           logger.info("Using sequential merge (single file or single core)")
           merged_feature_files = []
           with progress.create_file_bar(len(nucleotide_feature_files), desc="Merging features") as pbar:
               for nuc_feat, pro_feat in zip(nucleotide_feature_files, protein_feature_files):
                   base_name = nuc_feat.stem.replace('_DNABERT_S', '')
                   merged_file = merged_dir / f"{base_name}_merged.pt"
                   merge_features(nuc_feat, pro_feat, merged_file)
                   merged_feature_files.append(merged_file)
                   pbar.update(1)
       ```

    4. Add performance logging after merge:
       ```python
       logger.info(f"Merged {len(merged_feature_files)} feature files")
       ```

    This provides automatic parallelization with fallback, matching Phase 1.1 pattern.
  </action>
  <verify>grep -n "parallel_merge" virnucpro/pipeline/prediction.py</verify>
  <done>Stage 7 uses parallel merge with automatic fallback to sequential</done>
</task>

</tasks>

<verification>
# CLI parameter available
virnucpro predict --help | grep merge-threads

# Config includes parameter
grep "merge_threads" virnucpro/core/config.py

# Pipeline imports parallel merge
grep "from virnucpro.pipeline.parallel_merge" virnucpro/pipeline/prediction.py

# Stage 7 uses parallel merge
grep -A5 "use_parallel" virnucpro/pipeline/prediction.py | grep merge_threads
</verification>

<success_criteria>
- CLI provides --merge-threads parameter for user control
- Config dataclass includes merge_threads field
- Pipeline Stage 7 automatically uses parallel merge when beneficial
- Sequential fallback works for single file or single core
- Progress reporting maintained in both parallel and sequential modes
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-parallel-embedding-merge/02.1-02-SUMMARY.md`
</output>