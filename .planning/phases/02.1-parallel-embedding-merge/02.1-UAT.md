---
status: diagnosed
phase: 02.1-parallel-embedding-merge
source:
  - 02.1-01-SUMMARY.md
  - 02.1-02-SUMMARY.md
  - 02.1-03-SUMMARY.md
started: 2026-01-23T18:03:00Z
updated: 2026-01-23T18:11:00Z
---

## Current Test

[testing complete]

## Tests

### 1. CLI parameter --merge-threads
expected: Running `virnucpro predict --help` shows --merge-threads option with description. Default is auto-detection (uses CPU count). User can specify explicit value.
result: issue
reported: "Would it be better to have one catch-all threads parameter here or are there considerations that drive needing a different parameter?"
severity: minor

### 2. Automatic parallel merge activation
expected: Running prediction pipeline with multiple nucleotide/protein feature file pairs on multi-core system automatically uses parallel merge without requiring --merge-threads flag. Log shows "Using parallel merge with N workers".
result: skipped

### 3. Sequential fallback for single file
expected: Running prediction pipeline with only one feature file pair uses sequential merge (no parallel overhead). Log shows "Using sequential merge (single file or single core)".
result: issue
reported: "I used a single file input and see parallel merging: Using parallel merge with 48 workers. Merge complete: 5/5 files successful. Is this normal?"
severity: minor

### 4. Explicit --merge-threads control
expected: Running with `--merge-threads 2` uses exactly 2 workers for merge, regardless of CPU count. Log confirms worker count.
result: pass

### 5. Progress reporting during merge
expected: During feature merge stage, progress bar shows "Merging features" with file count and completion percentage. Updates in real-time as files are processed.
result: pass

### 6. Checkpoint/resume behavior
expected: If merge is interrupted and rerun, already-merged output files are skipped (not reprocessed). Log shows "Skipping merge - output exists" for completed files.
result: skipped

### 7. Partial failure handling
expected: If some file pairs fail to merge (e.g., missing files, mismatched sequences), pipeline continues with successful merges and logs warning about failures. Does not crash entire pipeline.
result: skipped

### 8. Performance improvement
expected: With multiple CPU cores and multiple file pairs (e.g., 10+ pairs on 4+ cores), parallel merge completes significantly faster than sequential would. At least 1.5-2x speedup observable.
result: pass

## Summary

total: 8
passed: 3
issues: 2
pending: 0
skipped: 3

## Gaps

- truth: "CLI provides unified thread control parameter"
  status: failed
  reason: "User reported: Would it be better to have one catch-all threads parameter here or are there considerations that drive needing a different parameter?"
  severity: minor
  test: 1
  root_cause: "Separate --threads and --merge-threads parameters exist due to incremental phase-by-phase implementation, not technical necessity"
  artifacts:
    - path: "virnucpro/cli/predict.py"
      issue: "Lines 67-74 define separate --threads and --merge-threads CLI options"
    - path: "virnucpro/pipeline/prediction.py"
      issue: "Lines 37-38, 137, 577 accept and use separate thread parameters for identical purposes"
  missing:
    - "Unified --threads parameter to replace both --threads and --merge-threads"
    - "Deprecation strategy if backwards compatibility desired (accept --merge-threads as alias)"
    - "Documentation update explaining single --threads controls all CPU parallelism"
  debug_session: ".planning/debug/cli-threads-parameter-design.md"

- truth: "Single input file uses sequential merge (no parallel overhead)"
  status: failed
  reason: "User reported: I used a single file input and see parallel merging: Using parallel merge with 48 workers. Merge complete: 5/5 files successful. Is this normal?"
  severity: minor
  test: 3
  root_cause: "Sequential fallback logic checks post-split feature file count instead of original input count. Phase 2 auto-splitting creates multiple files from single input for GPU load balancing, triggering parallel merge unexpectedly"
  artifacts:
    - path: "virnucpro/pipeline/prediction.py"
      issue: "Line 578 checks len(nucleotide_feature_files) > 1 which counts post-split files, not original inputs"
  missing:
    - "Design decision: track original input count OR accept workload-based optimization"
    - "If tracking inputs: Add original_input_file_count to pipeline metadata"
    - "If workload-based: Update documentation to clarify auto-split enables parallel merge"
  debug_session: ".planning/debug/sequential-fallback-single-input.md"
