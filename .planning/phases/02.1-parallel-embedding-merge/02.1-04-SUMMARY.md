---
phase: 02.1-parallel-embedding-merge
plan: 04
subsystem: cli-interface
tags: [cli, usability, parameter-consolidation, backward-compatibility]
requires: [02.1-02, 02.1-03]
provides: [unified-thread-control, simplified-cli]
affects: [user-scripts]

key-files:
  created: []
  modified:
    - virnucpro/cli/predict.py
    - tests/test_cli_predict.py

decisions:
  - id: unified-threads-parameter
    choice: Merge --threads and --merge-threads into single --threads parameter
    rationale: Simplifies user experience by having one parameter for CPU parallelism
    alternatives: Keep separate parameters (more complex UX)

  - id: alias-for-backward-compatibility
    choice: Keep --merge-threads as alias to --threads
    rationale: Existing user scripts won't break when upgrading
    alternatives: Remove --merge-threads entirely (breaking change)

tech-stack:
  added: []
  patterns:
    - click-multiple-flags-same-dest: Use multiple flag names (@click.option decorators) for same destination parameter

metrics:
  duration: 3.1 minutes
  completed: 2026-01-23
  commits: 2
  tasks: 3
---

# Phase 02.1 Plan 04: Unified Thread Control Summary

**One-liner:** Single --threads parameter controls both translation and merge with --merge-threads as backward-compatible alias

## What Was Built

Unified the CLI thread control parameters by consolidating `--threads` and `--merge-threads` into a single `--threads` parameter that controls all CPU parallelism (both six-frame translation and embedding merge).

**Key changes:**

1. **Unified CLI parameter** (`virnucpro/cli/predict.py`):
   - Combined `--threads` and `--merge-threads` into single parameter definition
   - Both flags (`-t`, `--threads`, `--merge-threads`) now set the same value
   - Updated help text: "Number of CPU threads for translation and merge (default: auto-detect)"
   - CLI passes same value to both `translation_threads` and `merge_threads` pipeline parameters

2. **Pipeline compatibility** (`virnucpro/pipeline/prediction.py`):
   - No changes needed - pipeline maintains descriptive parameter names internally
   - `translation_threads` and `merge_threads` both receive unified value from CLI
   - Clean separation: CLI exposes simple UX, pipeline maintains internal clarity

3. **Comprehensive tests** (`tests/test_cli_predict.py`):
   - `test_unified_threads_parameter`: Verifies `--threads 4` sets both parameters
   - `test_merge_threads_alias_backward_compatibility`: Verifies `--merge-threads 4` still works
   - Both tests confirm same behavior from either flag

## Deviations from Plan

None - plan executed exactly as written.

## Integration Points

**Modified:**
- CLI argument parsing in `virnucpro/cli/predict.py`
- Test suite in `tests/test_cli_predict.py`

**Unchanged:**
- Pipeline interface maintains separate parameters for internal clarity
- No changes to `virnucpro/pipeline/prediction.py` (already receives correct values)

## Decisions Made

**unified-threads-parameter:** Merged separate thread parameters into single `--threads` flag

- **Why:** Simplifies user experience - one parameter for CPU parallelism instead of two
- **Impact:** Users no longer need to understand translation vs. merge distinction for thread control
- **Alternatives considered:** Keep separate parameters (rejected due to UX complexity)

**alias-for-backward-compatibility:** Kept `--merge-threads` as alias

- **Why:** Prevents breaking existing user scripts that use `--merge-threads`
- **Implementation:** Click's multiple flags to same destination feature
- **User benefit:** Upgrade path is seamless - old and new flags work identically

## Performance Characteristics

**No performance impact** - this is a UX improvement only:

- Same thread counts used internally before and after change
- Both translation and merge now use consistent parallelism level
- Simplifies mental model: "I have N cores, use `--threads N`"

**User experience improvement:**

- **Before:** `--threads 4` (translation) + `--merge-threads 4` (merge) = 2 parameters
- **After:** `--threads 4` = 1 parameter controlling both stages
- **Backward compatible:** `--merge-threads 4` still works for legacy scripts

## Verification Results

All verification criteria passed:

1. ✅ Help text shows unified parameter: `--threads, --merge-threads INTEGER`
2. ✅ Help text describes both stages: "for translation and merge"
3. ✅ `--threads 4` sets both `translation_threads=4` and `merge_threads=4`
4. ✅ `--merge-threads 4` has same effect (backward compatibility)
5. ✅ Tests verify unified behavior

## Testing

**Unit tests added:**

```python
test_unified_threads_parameter
test_merge_threads_alias_backward_compatibility
```

Both tests verify:
- CLI accepts both flag variants
- Pipeline receives correct values for both parameters
- Same behavior regardless of which flag used

**Test coverage:**
- CLI parameter parsing
- Backward compatibility with deprecated flag
- Value propagation to pipeline

## Next Phase Readiness

**Ready to proceed** - no blockers identified.

This gap closure plan completes the Phase 02.1 UAT issue:

- UAT Issue: Users must manage `--threads` and `--merge-threads` separately
- Gap closure: Single `--threads` parameter with backward-compatible alias
- Result: Simplified UX without breaking existing scripts

## Files Modified

**virnucpro/cli/predict.py:**
- Merged `--threads` and `--merge-threads` parameter definitions (lines 67-70)
- Updated help text to mention both stages
- Pass unified value to both pipeline parameters (line 217)

**tests/test_cli_predict.py:**
- Added `test_unified_threads_parameter` (86 lines)
- Added `test_merge_threads_alias_backward_compatibility`
- Both use proper mocking for isolated CLI testing

## Lessons Learned

**Click's multi-flag feature:** The `@click.option('--flag1', '--flag2', dest='param')` pattern cleanly handles parameter aliases without code duplication.

**Internal vs. external naming:** Pipeline maintains descriptive parameter names (`translation_threads`, `merge_threads`) for code clarity while CLI exposes simplified UX (`--threads`). Best of both worlds.

**Backward compatibility is cheap:** Adding alias flag costs nothing in complexity but provides significant value to users with existing scripts.
