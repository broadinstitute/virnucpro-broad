---
phase: 02.1-parallel-embedding-merge
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - virnucpro/cli/predict.py
  - virnucpro/pipeline/prediction.py
  - tests/test_cli.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Single --threads parameter controls all CPU parallelism"
    - "Existing --merge-threads parameter still works for backward compatibility"
    - "CLI help clearly explains --threads controls both translation and merge"
  artifacts:
    - path: "virnucpro/cli/predict.py"
      provides: "Unified --threads parameter with --merge-threads alias"
      contains: "--threads.*translation and merge"
  key_links:
    - from: "virnucpro/cli/predict.py"
      to: "virnucpro/pipeline/prediction.py"
      via: "threads parameter passed to both stages"
      pattern: "threads.*translation.*merge"
---

<objective>
Unify thread control parameters by consolidating --threads and --merge-threads into a single --threads parameter that controls all CPU parallelism.

Purpose: Simplify user experience by having one parameter for CPU parallelism instead of separate parameters for each stage.
Output: Unified CLI parameter with backward compatibility for existing scripts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-parallel-embedding-merge/02.1-02-SUMMARY.md
@.planning/phases/02.1-parallel-embedding-merge/02.1-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify thread parameters in CLI</name>
  <files>virnucpro/cli/predict.py</files>
  <action>
    Modify the CLI argument parsing to:
    1. Keep --threads parameter (lines 67-70) but update help text to: "Number of CPU threads for translation and merge (default: auto-detect)"
    2. Make --merge-threads an alias/synonym for --threads (not a separate parameter)
    3. If user provides --merge-threads, internally map it to threads value
    4. Update help text to indicate --merge-threads is deprecated but still supported

    Implementation approach:
    - Use argparse's ability to have multiple flags for same dest
    - Both --threads and --merge-threads should set the same 'threads' destination
    - Remove the separate merge_threads argument definition (lines 71-74)

    Reference: Phase 02.1-02 added --merge-threads at lines 71-74
    Gap reason: Separate parameters exist due to incremental phase implementation, not technical necessity
  </action>
  <verify>python -m virnucpro predict --help | grep -A2 "threads"</verify>
  <done>--threads help text mentions "translation and merge", --merge-threads shown as alias</done>
</task>

<task type="auto">
  <name>Task 2: Update pipeline to use unified parameter</name>
  <files>virnucpro/pipeline/prediction.py</files>
  <action>
    Update the pipeline to use the single threads parameter for both translation and merge:
    1. At line 37-38, keep threads parameter but remove merge_threads parameter
    2. At line 137, use threads instead of merge_threads for Stage 7
    3. At line 577, use threads instead of merge_threads for determining worker count

    The logic should be:
    - Use threads value for both translation workers and merge workers
    - Auto-detection still works when threads=None (use CPU count)
    - Both stages benefit from same parallelism level

    Reference: Phase 02.1-02 added merge_threads usage at lines 577
    Gap reason: Need to unify parameter usage throughout pipeline
  </action>
  <verify>grep -n "merge_threads" virnucpro/pipeline/prediction.py</verify>
  <done>No occurrences of merge_threads found, only threads parameter used</done>
</task>

<task type="auto">
  <name>Task 3: Add CLI test for parameter unification</name>
  <files>tests/test_cli.py</files>
  <action>
    Add test cases to verify the unified thread parameter behavior:
    1. Test that --threads sets thread count for both translation and merge
    2. Test that --merge-threads (deprecated) still works and sets same value
    3. Test that help text shows proper description for --threads

    Create test function test_unified_threads_parameter() that:
    - Captures CLI help output and verifies --threads mentions both stages
    - Tests that --threads 4 results in 4 workers for both translation and merge
    - Tests that --merge-threads 4 (deprecated) has same effect as --threads 4

    Use subprocess or argparse testing patterns consistent with existing tests.
  </action>
  <verify>pytest tests/test_cli.py::test_unified_threads_parameter -xvs</verify>
  <done>Test passes, verifying unified parameter works for both stages</done>
</task>

</tasks>

<verification>
1. Run `python -m virnucpro predict --help` and verify --threads help text mentions both translation and merge
2. Run a prediction with --threads 2 and verify logs show both translation and merge using 2 workers
3. Run with deprecated --merge-threads 2 and verify it still works (backward compatibility)
4. Check that no merge_threads references remain in the codebase
</verification>

<success_criteria>
- Single --threads parameter controls all CPU parallelism (translation and merge)
- --merge-threads still works as an alias for backward compatibility
- Help text clearly indicates --threads controls both stages
- Tests verify unified behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-parallel-embedding-merge/02.1-04-SUMMARY.md`
</output>